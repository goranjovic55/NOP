# Exploit Builder Integration Fix - Testing Guide

## Problem Fixed
The exploit builder was showing **generic** configurations instead of **exploit-specific** data when navigating from vulnerability scans.

### Before Fix:
- Port: 4444 (generic reverse shell)
- Shell Type: Reverse shell
- Missing exploit-specific configurations

### After Fix:
- Port: 6200 (vsftpd backdoor actual port)
- Shell Type: Bind shell (correct type)
- Uses exploit metadata from CVE mappings

---

## Changes Made

### 1. Backend Changes
- **File**: `backend/app/api/v1/endpoints/vulnerabilities.py`
  - Added `exploit_metadata` field to `ExploitModuleResponse`
  
- **File**: `backend/app/services/exploit_match.py`
  - Updated `_module_to_dict()` to include `exploit_metadata` (placeholder for DB modules)
  - Static mappings already have metadata from `cve_to_exploits.json`

### 2. Frontend Changes
- **File**: `frontend/src/store/scanStore.ts`
  - Enhanced `Vulnerability` interface with nested `exploit_metadata` structure
  - Added fields: `trigger_port`, `shell_port`, `shell_type`, `payload_type`, etc.

- **File**: `frontend/src/pages/Scans.tsx`
  - Modified vulnerability scan to store full exploit object including `exploit_metadata`

- **File**: `frontend/src/pages/Access.tsx`
  - **Priority-based exploit configuration**:
    1. **Priority 1**: Use `exploit_metadata` if available (most specific)
    2. **Priority 2**: Use exploit module info (less specific)
    3. **Priority 3**: Fallback to service-based inference (old behavior)
  - Correctly sets port, shell type, and payload variant from metadata

---

## How to Test

### Test Setup
1. **Verify test environment is running**:
   ```bash
   cd /workspaces/NOP/test-environment
   docker-compose ps
   ```
   
   You should see `metasploitable2` container running with ports:
   - `21021:21` (FTP - vsftpd backdoor)
   - `6200:6200` (Backdoor shell port)

2. **Access the application**:
   - Open browser to `http://localhost:3000`
   - Login (default: admin/admin)

### Test Flow

#### Step 1: Scan for Vulnerabilities
1. Navigate to **Scans** page
2. Create new scan for IP: `localhost` or `127.0.0.1`
3. **Port Scan** first:
   - Click "▶ Scan" in Port Scan section
   - Wait for scan to complete
   - Should find port 21021 (FTP)

4. **Vulnerability Scan**:
   - Click "▶ Scan" in Vulnerability Scan section
   - This will:
     - Detect vsftpd 2.3.4
     - Lookup CVE-2011-2523
     - Find exploit in `cve_to_exploits.json`
     - Store full exploit metadata

#### Step 2: Navigate to Exploit Builder
1. Click on the vulnerability **CVE-2011-2523** in the list
   - OR click the "◉ Exploit" button at the top
   
2. **Verify Exploit Builder Auto-Population**:
   - ✅ **Port**: Should be `6200` (not 4444)
   - ✅ **Service**: `vsftpd backdoor shell` or `vsftpd_project/vsftpd`
   - ✅ **Payload Type**: `bind_shell` (not reverse_shell)
   - ✅ **Payload Variant**: `bash`
   - ✅ **Exploit Name**: `Exploit for CVE-2011-2523`

#### Step 3: Execute Exploit
1. Make sure target IP is set to `localhost` or `127.0.0.1`
2. Click "Deploy Exploit" button
3. Watch console output - should see:
   ```
   [*] Initializing bind_shell to 127.0.0.1:6200
   [*] Connecting to shell...
   [*] You now have bind shell access
   ```

---

## Exploit Metadata Structure

The `cve_to_exploits.json` contains metadata for known exploits:

```json
{
  "CVE-2011-2523": [
    {
      "platform": "metasploit",
      "module_id": "exploit/unix/ftp/vsftpd_234_backdoor",
      "title": "VSFTPD v2.3.4 Backdoor Command Execution",
      "exploit_metadata": {
        "trigger_port": 21,        // FTP port to trigger backdoor
        "shell_port": 6200,        // Port where shell appears
        "shell_type": "bind_shell", // Type of shell (bind vs reverse)
        "payload_type": "cmd/unix/interact",
        "requires_auth": false,
        "auto_exploit": true,
        "default_payload_variant": "bash"
      }
    }
  ]
}
```

### How It Works:
1. **Scan finds vsftpd 2.3.4** → Detects CVE-2011-2523
2. **Backend returns exploit** with full metadata
3. **Frontend stores** complete exploit object
4. **Access page reads** `exploit_metadata.shell_port` → Sets port to 6200
5. **Access page reads** `exploit_metadata.shell_type` → Sets type to bind_shell

---

## Debugging

### If Port is Still Wrong:
1. **Check browser console** for the vulnerability object:
   ```javascript
   // In browser dev tools console:
   // Navigate to exploit, then check:
   console.log(location.state.vulnerability)
   ```
   
2. **Verify exploit_data is present**:
   - Should have `exploit_data.exploit_metadata.shell_port = 6200`

3. **Check network tab**:
   - Look for `/api/v1/vulnerabilities/exploits/CVE-2011-2523`
   - Response should include `exploit_metadata` field

### If Exploit Metadata is Missing:
1. **Verify static mappings file**:
   ```bash
   cat backend/app/data/cve_to_exploits.json | grep -A 15 "CVE-2011-2523"
   ```

2. **Check backend logs**:
   ```bash
   docker-compose logs backend | grep -i exploit
   ```

---

## Additional Test Cases

### Test Other Exploits (if available):
- **CVE-2017-0144** (EternalBlue):
  - Should set reverse_shell + powershell
  - Port 445
  
- **CVE-2014-6271** (Shellshock):
  - Should set web_shell or reverse_shell
  - Port 80/443

### Add New Exploits:
To add more exploit metadata, edit `backend/app/data/cve_to_exploits.json`:
```json
{
  "CVE-YYYY-XXXXX": [
    {
      "platform": "metasploit",
      "module_id": "exploit/...",
      "title": "...",
      "exploit_metadata": {
        "trigger_port": ...,
        "shell_port": ...,
        "shell_type": "bind_shell|reverse_shell",
        "default_payload_variant": "bash|powershell|python"
      }
    }
  ]
}
```

---

## Success Criteria

✅ Port is **6200** (not 4444)  
✅ Shell type is **bind_shell** (not reverse_shell)  
✅ Payload variant is **bash**  
✅ Service description is exploit-specific  
✅ Exploit can be executed and connects to correct port  

---

## Notes

- **Fallback behavior**: If `exploit_metadata` is missing, system falls back to intelligent guessing based on service names
- **Extensible**: Add more exploits to `cve_to_exploits.json` with detailed metadata
- **Priority system**: Most specific data wins (metadata > module_id > service name)

