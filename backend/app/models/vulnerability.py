"""
Vulnerability model for security findings
"""

from sqlalchemy import Column, String, DateTime, Float, Text, JSON, ForeignKey
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
import uuid
import enum

from app.core.database import Base


class VulnerabilitySeverity(str, enum.Enum):
    """Vulnerability severity levels"""
    INFO = "info"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"


class VulnerabilityStatus(str, enum.Enum):
    """Vulnerability status"""
    NEW = "new"
    CONFIRMED = "confirmed"
    FALSE_POSITIVE = "false_positive"
    MITIGATED = "mitigated"
    FIXED = "fixed"
    IGNORED = "ignored"


class Vulnerability(Base):
    """Vulnerability finding"""
    __tablename__ = "vulnerabilities"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # Asset association
    asset_id = Column(UUID(as_uuid=True), ForeignKey("assets.id"), nullable=False)
    asset = relationship("Asset", backref="vulnerabilities")
    
    # Scan association (optional)
    scan_id = Column(UUID(as_uuid=True), ForeignKey("scans.id"), nullable=True)
    scan = relationship("Scan", backref="vulnerabilities")
    
    # Vulnerability identification
    cve_id = Column(String(20), nullable=True, index=True)  # CVE-2023-1234
    cwe_id = Column(String(20), nullable=True)  # CWE-79
    title = Column(String(200), nullable=False)
    description = Column(Text, nullable=True)
    
    # Severity and scoring
    severity = Column(String(20), nullable=False, index=True)
    cvss_score = Column(Float, nullable=True)  # 0.0 - 10.0
    cvss_vector = Column(String(100), nullable=True)
    
    # Affected component
    service = Column(String(100), nullable=True)
    port = Column(String(10), nullable=True)
    protocol = Column(String(10), nullable=True)
    version = Column(String(100), nullable=True)
    
    # Status and management
    status = Column(String(20), default=VulnerabilityStatus.NEW, nullable=False)
    false_positive = Column(String(10), default="false", nullable=False)
    
    # Remediation
    solution = Column(Text, nullable=True)
    references = Column(JSON, nullable=True)  # List of reference URLs
    
    # Discovery information
    discovered_by = Column(String(50), nullable=True)  # Tool/method that found it
    confidence = Column(Float, default=1.0, nullable=False)  # 0.0 - 1.0
    
    # Evidence
    proof_of_concept = Column(Text, nullable=True)
    evidence = Column(JSON, nullable=True)  # Screenshots, logs, etc.
    
    # Timestamps
    first_seen = Column(DateTime(timezone=True), server_default=func.now())
    last_seen = Column(DateTime(timezone=True), server_default=func.now())
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    def __repr__(self):
        return f"<Vulnerability(cve='{self.cve_id}', severity='{self.severity}', asset_id='{self.asset_id}')>"