"""
Exploit Module model for CVE-to-exploit mappings
"""

from sqlalchemy import Column, String, DateTime, Text, Boolean, Integer
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.sql import func
import uuid
import enum

from app.core.database import Base


class ExploitType(str, enum.Enum):
    """Types of exploits"""
    METASPLOIT = "metasploit"
    EXPLOIT_DB = "exploit_db"
    CUSTOM = "custom"
    POC = "poc"


class ExploitRank(str, enum.Enum):
    """Metasploit reliability ranking"""
    MANUAL = "manual"
    LOW = "low"
    AVERAGE = "average"
    NORMAL = "normal"
    GOOD = "good"
    GREAT = "great"
    EXCELLENT = "excellent"


class ExploitModule(Base):
    """CVE to exploit module mapping"""
    __tablename__ = "exploit_modules"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # CVE association
    cve_id = Column(String(20), nullable=False, index=True)  # CVE-2023-1234
    
    # Platform/framework
    platform = Column(String(50), nullable=False)  # metasploit, exploit-db, etc.
    
    # Module identification
    module_id = Column(String(100), nullable=True)  # exploit/linux/http/jenkins_cli_rce
    module_path = Column(String(255), nullable=True)  # Full path to module
    
    # Module metadata
    title = Column(String(500), nullable=False)
    description = Column(Text, nullable=True)
    
    # Classification
    exploit_type = Column(String(20), nullable=False, default=ExploitType.METASPLOIT)
    target_platform = Column(String(50), nullable=True)  # linux, windows, unix, etc.
    
    # Reliability
    rank = Column(String(20), nullable=True, default=ExploitRank.NORMAL)
    verified = Column(Boolean, default=False)  # Verified to work
    
    # External references
    exploit_db_id = Column(Integer, nullable=True)  # Exploit-DB ID
    reference_url = Column(String(500), nullable=True)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    def __repr__(self):
        return f"<ExploitModule(cve_id='{self.cve_id}', module='{self.module_id}')>"
