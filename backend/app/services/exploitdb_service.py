"""
Exploit-DB Integration Service
"""
import subprocess
import json
import logging
import re
from typing import List, Dict, Any, Optional

logger = logging.getLogger(__name__)


class ExploitDBService:
    """Service for querying Exploit-DB using searchsploit"""
    
    def __init__(self):
        self.searchsploit_path = "/usr/local/bin/searchsploit"
    
    async def search_by_cve(self, cve_id: str) -> List[Dict[str, Any]]:
        """
        Search Exploit-DB for exploits related to a CVE
        
        Args:
            cve_id: CVE identifier (e.g., CVE-2014-6271)
            
        Returns:
            List of exploit dicts with metadata
        """
        try:
            # Run searchsploit with JSON output
            cmd = [self.searchsploit_path, "--json", "--cve", cve_id]
            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode != 0:
                logger.warning(f"searchsploit failed for {cve_id}: {result.stderr}")
                return []
            
            # Parse JSON output
            try:
                data = json.loads(result.stdout)
                exploits = data.get("RESULTS_EXPLOIT", [])
                
                # Transform to our format
                formatted_exploits = []
                for exploit in exploits:
                    formatted_exploits.append({
                        "id": f"exploitdb-{exploit.get('EDB-ID', 'unknown')}",
                        "cve_id": cve_id,
                        "platform": "exploit-db",
                        "module_id": None,
                        "module_path": exploit.get("Path", ""),
                        "title": exploit.get("Title", "Unknown"),
                        "description": f"Exploit-DB ID: {exploit.get('EDB-ID')}. {exploit.get('Title', '')}",
                        "exploit_type": exploit.get("Type", "unknown"),
                        "target_platform": exploit.get("Platform", "unknown"),
                        "rank": "normal",
                        "verified": exploit.get("Verified", False),
                        "exploit_db_id": int(exploit.get("EDB-ID", 0)),
                        "reference_url": f"https://www.exploit-db.com/exploits/{exploit.get('EDB-ID', 0)}"
                    })
                
                logger.info(f"Found {len(formatted_exploits)} exploits for {cve_id} from Exploit-DB")
                return formatted_exploits
                
            except json.JSONDecodeError as e:
                logger.error(f"Failed to parse searchsploit JSON output: {e}")
                return []
            
        except subprocess.TimeoutExpired:
            logger.error(f"searchsploit timeout for {cve_id}")
            return []
        except Exception as e:
            logger.error(f"Error searching Exploit-DB for {cve_id}: {str(e)}")
            return []
    
    async def search_by_text(self, query: str, max_results: int = 10) -> List[Dict[str, Any]]:
        """
        Search Exploit-DB by text query
        
        Args:
            query: Search query
            max_results: Maximum number of results to return
            
        Returns:
            List of exploit dicts
        """
        try:
            cmd = [self.searchsploit_path, "--json", query]
            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode != 0:
                return []
            
            data = json.loads(result.stdout)
            exploits = data.get("RESULTS_EXPLOIT", [])[:max_results]
            
            formatted_exploits = []
            for exploit in exploits:
                formatted_exploits.append({
                    "id": f"exploitdb-{exploit.get('EDB-ID', 'unknown')}",
                    "platform": "exploit-db",
                    "title": exploit.get("Title", "Unknown"),
                    "exploit_db_id": int(exploit.get("EDB-ID", 0)),
                    "target_platform": exploit.get("Platform", "unknown"),
                    "reference_url": f"https://www.exploit-db.com/exploits/{exploit.get('EDB-ID', 0)}"
                })
            
            return formatted_exploits
            
        except Exception as e:
            logger.error(f"Error in text search: {str(e)}")
            return []
